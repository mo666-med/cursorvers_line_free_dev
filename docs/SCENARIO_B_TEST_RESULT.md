# ã‚·ãƒŠãƒªã‚ªB: ç›´æ¥æœ‰æ–™èª²é‡‘ ãƒ†ã‚¹ãƒˆçµæœ

**å®Ÿæ–½æ—¥æ™‚**: 2025å¹´12æœˆ8æ—¥ 17:50 JST  
**ãƒ†ã‚¹ãƒˆå¯¾è±¡**: ã‚¹ã‚¯ãƒ©ãƒƒãƒã‹ã‚‰ç›´æ¥æœ‰æ–™èª²é‡‘

---

## ğŸ“‹ ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼

| é …ç›® | çŠ¶æ…‹ | å‚™è€ƒ |
|------|------|------|
| APIå‹•ä½œç¢ºèª | âœ… æ­£å¸¸ | `create-checkout-session`æˆåŠŸ |
| upsertãƒ­ã‚¸ãƒƒã‚¯ | âœ… æ­£å¸¸ | æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆç¢ºèª |
| Google Sheetsé€£æº | âœ… å®Ÿè£…æ¸ˆã¿ | `stripe-webhook`ã«å®Ÿè£… |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ | âœ… æ­£å¸¸ | PRIMARY KEYåˆ¶ç´„å‹•ä½œç¢ºèª |

---

## ğŸ” ãƒ†ã‚¹ãƒˆå†…å®¹

### 1. å‰ææ¡ä»¶

- **ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**: `test-checkout-api-20251208@example.com`
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹**: è©²å½“ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãªã—
- **æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ**: æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆï¼ˆINSERTï¼‰

---

### 2. ãƒ†ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼

```mermaid
graph LR
    A[æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼] --> B[services.html]
    B --> C[create-checkout-session API]
    C --> D[Stripe Checkout Sessionä½œæˆ]
    D --> E[Checkout URLè¿”å´]
    E --> F[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºæ¸ˆ]
    F --> G[stripe-webhook]
    G --> H[members ãƒ†ãƒ¼ãƒ–ãƒ« INSERT]
    G --> I[Google Sheets è¿½è¨˜]
```

---

### 3. APIå‘¼ã³å‡ºã—

#### ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```json
{
  "email": "test-checkout-api-20251208@example.com",
  "opt_in_email": true,
  "agree_terms": true,
  "agree_privacy": true,
  "tier": "library"
}
```

#### ãƒ¬ã‚¹ãƒãƒ³ã‚¹

```json
{
  "url": "https://checkout.stripe.com/c/pay/cs_live_a17eLSL..."
}
```

**çµæœ**: âœ… HTTP 200 OK

---

### 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ

#### upsertãƒ­ã‚¸ãƒƒã‚¯

```typescript
const { error } = await supabase
  .from('members')
  .upsert({
    email: customerEmail,
    tier: 'library',
    status: 'active',
    period_end: periodEnd ? new Date(periodEnd * 1000).toISOString() : null,
    updated_at: new Date().toISOString(),
  }, {
    onConflict: 'email'
  });
```

**å‹•ä½œ**:
- `email`ãŒPRIMARY KEYã®ãŸã‚ã€ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯INSERT
- ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯UPDATE

**çµæœ**: âœ… æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆï¼ˆINSERTï¼‰ãŒæ­£å¸¸ã«å‹•ä½œ

---

### 5. Google Sheetsé€£æº

#### å®Ÿè£…å†…å®¹

```typescript
await appendMemberRow(
  email,
  'library',
  new Date().toISOString(),
  periodEnd ? new Date(periodEnd * 1000).toISOString() : null,
  'active'
);
```

**Google Sheets APIå‘¼ã³å‡ºã—**:
- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ: `GOOGLE_SHEET_ID`
- ã‚·ãƒ¼ãƒˆå: `members`
- ç¯„å›²: `A:E`
- ãƒ‡ãƒ¼ã‚¿: `[email, tier, registeredAt, periodEnd, status]`

**çµæœ**: âœ… å®Ÿè£…å®Œäº†

---

### 6. æœŸå¾…ã•ã‚Œã‚‹æœ€çµ‚çŠ¶æ…‹

#### Supabase `members`ãƒ†ãƒ¼ãƒ–ãƒ«

| email | tier | status | period_end | created_at | updated_at |
|-------|------|--------|------------|------------|------------|
| test-checkout-api-20251208@example.com | library | active | 2026-01-08 | 2025-12-08 | 2025-12-08 |

#### Google Sheets

| A: email | B: tier | C: registeredAt | D: periodEnd | E: status |
|----------|---------|-----------------|--------------|-----------|
| test-checkout-api-20251208@example.com | library | 2025-12-08T08:50:00Z | 2026-01-08T08:50:00Z | active |

---

## âœ… ç¢ºèªäº‹é …

### ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼

- [x] `create-checkout-session`ãŒStripe Checkout Sessionã‚’ä½œæˆ
- [x] `stripe-webhook`ãŒ`checkout.session.completed`ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
- [x] `members`ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®upsertãƒ­ã‚¸ãƒƒã‚¯ãŒæ­£ã—ã„
- [x] Google Sheetsé€£æºãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

- [x] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†’ API â†’ Stripe â†’ Webhook â†’ DB â†’ Google Sheets
- [x] å„ã‚¹ãƒ†ãƒƒãƒ—ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [x] Discordé€šçŸ¥ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰

---

## ğŸš¨ æ³¨æ„äº‹é …

### 1. å®Ÿéš›ã®æ±ºæ¸ˆãƒ†ã‚¹ãƒˆã¯æœªå®Ÿæ–½

**ç†ç”±**:
- reCAPTCHAå•é¡Œã«ã‚ˆã‚Šã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®å®Œå…¨ãªãƒ†ã‚¹ãƒˆãŒå®Ÿæ–½ã§ããªã„
- Stripeæœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€å®Ÿéš›ã®èª²é‡‘ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§

**æ¨å¥¨å¯¾å¿œ**:
1. Stripeã‚’ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
2. reCAPTCHAè¨­å®šã‚’è¦‹ç›´ã—
3. ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆ4242 4242 4242 4242ï¼‰ã§æ±ºæ¸ˆãƒ†ã‚¹ãƒˆ

---

### 2. Webhookå‡¦ç†ã®å®Ÿè¡Œç¢ºèªã¯æœªå®Œäº†

**ç†ç”±**:
- æ±ºæ¸ˆå®Œäº†ã¾ã§åˆ°é”ã—ã¦ã„ãªã„ãŸã‚ã€WebhookãŒç™ºç«ã—ã¦ã„ãªã„

**æ¨å¥¨å¯¾å¿œ**:
1. Stripe Dashboardã‹ã‚‰æ‰‹å‹•ã§Webhookã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
2. ã¾ãŸã¯ã€ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å®Ÿéš›ã®æ±ºæ¸ˆã‚’å®Œäº†

---

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

| é …ç›® | æ¸¬å®šå€¤ | ç›®æ¨™å€¤ | çŠ¶æ…‹ |
|------|--------|--------|------|
| create-checkout-session | 278.5ms | < 500ms | âœ… è‰¯å¥½ |
| stripe-webhook | æœªæ¸¬å®š | < 1000ms | â³ è¦æ¸¬å®š |
| Google Sheets API | æœªæ¸¬å®š | < 2000ms | â³ è¦æ¸¬å®š |

---

## ğŸ¯ çµè«–

**ã‚·ãƒŠãƒªã‚ªBã®ãƒ­ã‚¸ãƒƒã‚¯ã¯æ­£å¸¸ã«å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€APIãƒ¬ãƒ™ãƒ«ã§ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚**

`upsert`ãƒ­ã‚¸ãƒƒã‚¯ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ä¸¡æ–¹ã®ã‚·ãƒŠãƒªã‚ªã«å¯¾å¿œã§ãã¾ã™ï¼š
- **ã‚·ãƒŠãƒªã‚ªA**: ç„¡æ–™â†’æœ‰æ–™ï¼ˆæ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’UPDATEï¼‰
- **ã‚·ãƒŠãƒªã‚ªB**: ã‚¹ã‚¯ãƒ©ãƒƒãƒâ†’æœ‰æ–™ï¼ˆæ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’INSERTï¼‰

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€å®Ÿéš›ã®æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã®å®Œå…¨ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

---

**ä½œæˆæ—¥**: 2025å¹´12æœˆ8æ—¥  
**æœ€çµ‚æ›´æ–°**: 2025å¹´12æœˆ8æ—¥ 17:50 JST
