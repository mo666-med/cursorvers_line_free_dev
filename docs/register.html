<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Free Community Join</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-[#050202] text-white min-h-screen">
  <main class="max-w-xl mx-auto px-6 py-10 space-y-6">
    <div class="space-y-2">
      <p class="text-xs uppercase tracking-[0.4em] text-orange-500 font-bold">Free Community</p>
      <h1 class="text-3xl font-bold text-white">å‚åŠ ãƒ•ã‚©ãƒ¼ãƒ </h1>
      <p class="text-sm text-white/80">
        LINEã§å‹ã ã¡è¿½åŠ ã—ã€æœ€æ–°ã®Safety &amp; Literacyã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
        <span class="text-orange-500 font-semibold">ãƒ¡ãƒ¼ãƒ«ç™»éŒ²ã§ã€ŒSafetyã‚¹ã‚¿ãƒ¼ãƒˆãƒ‘ãƒƒã‚¯ã€ï¼ˆæœ€æ–°AIå‰¯æ¥­ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‹å®‰å…¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆLiteï¼‰ã‚’é…å¸ƒ</span>ã€‚
        ã¾ãšãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¦ã‹ã‚‰ã€LINEç™»éŒ²ã«é€²ã¿ã¾ã™ã€‚
      </p>
      <p class="text-xs text-orange-500">PHIï¼ˆè¨ºç™‚æƒ…å ±ï¼‰ã¯çµ¶å¯¾ã«å…¥åŠ›ã—ãªã„ã§ãã ã•ã„ã€‚</p>
    </div>

    <div id="status" class="text-sm"></div>

    <form id="community-form" class="space-y-4 bg-[#0F0505] border border-white/10 rounded-2xl p-6 shadow-lg">
      <label class="flex items-start gap-3 text-sm text-white/80">
        <input id="email-opt-in" type="checkbox" class="mt-1 rounded border-white/25 bg-black/30 text-orange-500 focus:ring-orange-500" checked>
        <span>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¦ç‰¹å…¸ã‚’å—ã‘å–ã‚‹ï¼ˆåˆæœŸONï¼‰</span>
      </label>

      <div id="email-input-section" class="space-y-2">
        <label for="email" class="text-sm font-semibold text-white">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input id="email" name="email" type="email" autocomplete="email" placeholder="you@example.com" class="w-full rounded-lg border border-white/15 bg-black/30 px-4 py-3 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
        <p class="text-xs text-white/50">ãƒ¡ãƒ¼ãƒ«ç™»éŒ²ã§ã€ŒSafetyã‚¹ã‚¿ãƒ¼ãƒˆãƒ‘ãƒƒã‚¯ã€ã‚’é…å¸ƒã—ã¾ã™ã€‚</p>
      </div>

      <label class="flex items-start gap-3 text-sm text-white/80">
        <input id="opt-in" type="checkbox" class="mt-1 rounded border-white/25 bg-black/30 text-orange-500 focus:ring-orange-500" checked>
        <span>ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¬ã‚¿ãƒ¼ï¼ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ãƒ¡ãƒ¼ãƒ«ã§å—ã‘å–ã‚‹ï¼ˆä»»æ„ã€åˆæœŸONï¼‰</span>
      </label>

      <label class="flex items-start gap-3 text-sm text-white/80">
        <input id="agree" type="checkbox" class="mt-1 rounded border-white/25 bg-black/30 text-orange-500 focus:ring-orange-500" required>
        <span><a href="terms.html" class="underline hover:text-orange-500" target="_blank" rel="noopener">åˆ©ç”¨è¦ç´„</a>ãƒ»<a href="privacy.html" class="underline hover:text-orange-500" target="_blank" rel="noopener">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ãƒ»PHIç¦æ­¢ã«åŒæ„ã™ã‚‹</span>
      </label>

      <button id="email-submit-btn" type="button" class="w-full rounded-full bg-orange-500 text-white font-bold py-3 hover:bg-orange-600 transition focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2">
        LINEç™»éŒ²ã«é€²ã‚€
      </button>

      <div id="line-login-section" class="hidden space-y-4">
        <div class="text-center">
          <p id="line-login-message" class="text-sm text-white/80 mb-4"></p>
          <button id="line-login-btn" type="button" class="w-full rounded-full bg-orange-500 text-white font-bold py-3 hover:bg-orange-600 transition">
            LINEã§ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
      </div>

      <!-- QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="qr-code-section" class="hidden space-y-4">
        <div class="text-center bg-[#0F0505] border border-white/10 rounded-2xl p-6 shadow-lg">
          <p class="text-white font-semibold mb-4">LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ ã—ã¦ãã ã•ã„</p>
          <a href="https://line.me/R/ti/p/@529ybhfo" target="_blank" rel="noopener">
            <img id="line-qr-code" src="https://qr-official.line.me/gs/M_529ybhfo_GW.png" alt="LINE QRã‚³ãƒ¼ãƒ‰" class="mx-auto w-48 h-48 mb-4 cursor-pointer">
          </a>
          <div class="space-y-2">
            <p class="text-white/80 text-sm">PCã®æ–¹ï¼šã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</p>
            <p class="text-orange-500 text-sm font-semibold">ğŸ“± iPhoneã®æ–¹ï¼šQRã‚³ãƒ¼ãƒ‰ã‚’é•·æŠ¼ã—ã—ã¦ã€ŒLINEã§é–‹ãã€ã‚’é¸æŠ</p>
          </div>
        </div>
      </div>

      <p id="line-user" class="text-xs text-white/40"></p>
    </form>
  </main>

  <script>
    const LIFF_FALLBACK_ID = "2008640048-jnoneGgO"; // æ—§LIFFï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰
    const API_ENDPOINT = "https://haaxgwyimoqzzxzdaeep.functions.supabase.co/line-register";
    const statusEl = document.getElementById("status");
    const userEl = document.getElementById("line-user");
    const form = document.getElementById("community-form");
    const emailSubmitBtn = document.getElementById("email-submit-btn");
    const lineLoginSection = document.getElementById("line-login-section");
    const lineLoginBtn = document.getElementById("line-login-btn");
    const lineLoginMessage = document.getElementById("line-login-message");
    const emailOptIn = document.getElementById("email-opt-in");
    const emailInputSection = document.getElementById("email-input-section");
    const qrCodeSection = document.getElementById("qr-code-section");

    let savedEmail = "";
    let savedOptIn = true;
    let lineUserId = "";
    let liffId = "";

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç™»éŒ²ãƒˆã‚°ãƒ«
    emailOptIn.addEventListener("change", (e) => {
      emailInputSection.style.display = e.target.checked ? "block" : "none";
    });

    const setStatus = (msg, isError = true) => {
      statusEl.textContent = msg;
      statusEl.className = isError ? "text-sm text-orange-400" : "text-sm text-gray-200";
    };

    // QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showQRCode() {
      form.querySelector('label.flex.items-start').style.display = 'none';
      emailInputSection.style.display = 'none';
      emailSubmitBtn.style.display = 'none';
      lineLoginSection.classList.add('hidden');
      qrCodeSection.classList.remove('hidden');
      
      // ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ©ãƒ™ãƒ«ã‚’éè¡¨ç¤º
      const checkboxLabels = form.querySelectorAll('label.flex.items-start');
      checkboxLabels.forEach(label => label.style.display = 'none');
    }

    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆä»»æ„ï¼‰
    emailSubmitBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      const emailOptInChecked = emailOptIn.checked;
      const email = emailOptInChecked ? (document.getElementById("email").value || "").trim() : "";
      const optIn = document.getElementById("opt-in").checked;
      const agree = document.getElementById("agree").checked;

      if (!agree) {
        setStatus("åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®åŒæ„ãŒå¿…è¦ã§ã™ã€‚");
        return;
      }
      emailSubmitBtn.disabled = true;
      emailSubmitBtn.textContent = "å‡¦ç†ä¸­...";
      setStatus("");

      try {
        if (emailOptInChecked && email) {
          const res = await fetch(API_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, opt_in_email: optIn }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.error || "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");

          savedEmail = email;
          savedOptIn = optIn;
          sessionStorage.setItem("savedEmail", email);
          sessionStorage.setItem("savedOptIn", optIn.toString());
          setStatus("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ä¸‹ã®QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ ã—ã¦ãã ã•ã„ã€‚", false);
        } else {
          savedEmail = "";
          savedOptIn = optIn;
          sessionStorage.setItem("savedEmail", "");
          sessionStorage.setItem("savedOptIn", optIn.toString());
          setStatus("ä¸‹ã®QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ ã—ã¦ãã ã•ã„ã€‚", false);
        }

        // QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
        showQRCode();
      } catch (err) {
        console.error(err);
        setStatus(err.message || "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ");
      } finally {
        emailSubmitBtn.disabled = false;
        emailSubmitBtn.textContent = "LINEç™»éŒ²ã«é€²ã‚€";
      }
    });

    // LINEãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ï¼ˆQRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºå¾Œã¯ä½¿ç”¨ã—ãªã„ãŒã€äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
    lineLoginBtn.addEventListener("click", async () => {
      const qsId = new URLSearchParams(location.search).get("liffId");
      liffId = qsId || LIFF_FALLBACK_ID;
      if (!liffId) {
        setStatus("LIFF ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }
      try {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        await linkLineAccount();
      } catch (err) {
        console.error(err);
        setStatus("LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
      }
    });

    async function linkLineAccount() {
      try {
        const profile = await liff.getProfile();
        lineUserId = profile.userId;
        userEl.textContent = `LINE ID: ${lineUserId}`;

        // Get id_token for LINE login verification
        const idToken = liff.getIDToken();
        
        const payload = { line_user_id: lineUserId, opt_in_email: savedOptIn };
        if (savedEmail) payload.email = savedEmail;
        if (idToken) payload.id_token = idToken;

        const res = await fetch(API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || "LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç´ä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸ");

        setStatus("ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼LINEã§é…ä¿¡ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚", false);
        lineLoginSection.classList.add("hidden");
        sessionStorage.removeItem("savedEmail");
        sessionStorage.removeItem("savedOptIn");
      } catch (err) {
        console.error(err);
        setStatus(err.message || "LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç´ä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }

    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œï¼ˆcodeä»˜ãï¼‰ã®å¾©å…ƒ
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("code")) {
      const qsId = new URLSearchParams(location.search).get("liffId");
      liffId = qsId || LIFF_FALLBACK_ID;
      savedEmail = sessionStorage.getItem("savedEmail") || "";
      savedOptIn = sessionStorage.getItem("savedOptIn") === "true";
      if (liffId) {
        (async () => {
          try {
            await liff.init({ liffId });
            if (liff.isLoggedIn()) {
              await linkLineAccount();
            }
          } catch (err) {
            console.error(err);
            setStatus("LINEãƒ­ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        })();
      }
    } else {
      const storedEmail = sessionStorage.getItem("savedEmail");
      if (storedEmail) {
        document.getElementById("email").value = storedEmail;
        savedEmail = storedEmail;
        savedOptIn = sessionStorage.getItem("savedOptIn") === "true";
        document.getElementById("opt-in").checked = savedOptIn;
        form.querySelector("div.space-y-2").style.display = "none";
        form.querySelector("label.flex.items-start").style.display = "none";
        emailSubmitBtn.style.display = "none";
        lineLoginSection.classList.remove("hidden");
      }
    }
  </script>
</body>
</html>
