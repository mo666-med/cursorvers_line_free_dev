name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - main
    paths:
      - "supabase/functions/**"
      - ".github/workflows/deploy-supabase.yml"
  workflow_dispatch:

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  DISCORD_SYSTEM_WEBHOOK: ${{ secrets.DISCORD_SYSTEM_WEBHOOK }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # ========================================
      # Core Functions (JWT検証あり)
      # ========================================
      - name: Deploy line-webhook
        run: supabase functions deploy line-webhook --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      - name: Deploy line-daily-brief
        run: supabase functions deploy line-daily-brief --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      - name: Deploy stats-exporter
        run: supabase functions deploy stats-exporter --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      - name: Deploy health-check
        run: supabase functions deploy health-check --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      - name: Deploy manus-audit-line-daily-brief
        run: supabase functions deploy manus-audit-line-daily-brief --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      - name: Deploy relay
        run: supabase functions deploy relay --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      # ========================================
      # Webhook Functions (JWT検証なし - 外部からのリクエスト受付)
      # ========================================
      - name: Deploy stripe-webhook
        run: supabase functions deploy stripe-webhook --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      - name: Deploy create-checkout-session
        run: supabase functions deploy create-checkout-session --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      - name: Deploy ingest-hij
        run: supabase functions deploy ingest-hij --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      - name: Deploy generate-sec-brief
        run: supabase functions deploy generate-sec-brief --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      - name: Deploy line-register
        run: supabase functions deploy line-register --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      - name: Deploy discord-bot
        run: supabase functions deploy discord-bot --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID"
        continue-on-error: true

      # ========================================
      # Notification
      # ========================================
      - name: Send Discord notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')

          if [ "$STATUS" = "success" ]; then
            EMOJI="✅"
            COLOR="5763719"
          else
            EMOJI="⚠️"
            COLOR="16776960"
          fi

          curl -X POST "$DISCORD_SYSTEM_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"${EMOJI} Edge Functions Deploy ${STATUS}\", \"description\": \"全12関数のデプロイを実行\", \"color\": ${COLOR}, \"fields\": [{\"name\": \"Commit\", \"value\": \"${GITHUB_SHA:0:7}\", \"inline\": true}, {\"name\": \"Time\", \"value\": \"${TIMESTAMP}\", \"inline\": true}], \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}]}"
