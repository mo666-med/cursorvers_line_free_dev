# .github/workflows/verification-reminder-cron.yml
# æ¯æ—¥1å› èªè¨¼ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

name: Verification Reminder

on:
  schedule:
    # æ¯æ—¥ JST 09:00 (UTC 00:00) ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

concurrency:
  group: verification-reminder
  cancel-in-progress: true

jobs:
  send-reminders:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Setup log directory
        run: |
          mkdir -p workflow-logs
          echo "LOG_FILE=workflow-logs/verification-reminder-$(date -u +%Y%m%d_%H%M%S).log" >> $GITHUB_ENV

      - name: Trigger verification-reminder Edge Function
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          exec > >(tee -a "$LOG_FILE") 2>&1
          echo "ğŸ“§ èªè¨¼ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’å®Ÿè¡Œä¸­..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${SUPABASE_URL}/functions/v1/verification-reminder" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${CRON_SECRET}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ Edge Function returned $HTTP_CODE"
            exit 1
          fi

          # çµ±è¨ˆã‚’å‡ºåŠ›
          PROCESSED=$(echo "$BODY" | jq -r '.processed // 0')
          FIRST=$(echo "$BODY" | jq -r '.stats.firstReminder // 0')
          SECOND=$(echo "$BODY" | jq -r '.stats.secondReminder // 0')
          FINAL=$(echo "$BODY" | jq -r '.stats.finalInvite // 0')
          ERRORS=$(echo "$BODY" | jq -r '.stats.errors // 0')

          echo "âœ… èªè¨¼ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼å®Ÿè¡Œå®Œäº†"
          echo "ğŸ“Š çµ±è¨ˆ:"
          echo "   - å‡¦ç†å¯¾è±¡: ${PROCESSED}ä»¶"
          echo "   - 1å›ç›®ãƒªãƒã‚¤ãƒ³ãƒ‰: ${FIRST}ä»¶"
          echo "   - 2å›ç›®ãƒªãƒã‚¤ãƒ³ãƒ‰: ${SECOND}ä»¶"
          echo "   - æœ€çµ‚Discordæ‹›å¾…: ${FINAL}ä»¶"
          echo "   - ã‚¨ãƒ©ãƒ¼: ${ERRORS}ä»¶"

      - name: Notify on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{"content": "âš ï¸ **èªè¨¼ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸ**\nhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
          fi

      - name: Upload workflow logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-reminder-logs-${{ github.run_number }}-${{ github.run_attempt }}
          path: workflow-logs/
          retention-days: 90
