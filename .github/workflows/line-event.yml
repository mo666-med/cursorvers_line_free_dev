name: LINE Event Handler
x-owner: devops

on:
  repository_dispatch:
    types: [line_event]
  workflow_dispatch:
    inputs:
      payload_path:
        description: 'Path to event payload JSON file (relative to repo root)'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

env:
  PLAN_CURRENT_PATH: orchestration/plan/current_plan.json
  PLAN_DELTA_PATH: orchestration/plan/plan_delta.json
  PRODUCTION_PLAN_PATH: orchestration/plan/production/current_plan.json
  DEGRADED_PLAN_PATH: orchestration/plan/production/degraded_plan.json
  DEGRADED_FLAG_PATH: orchestration/plan/production/degraded.flag
  LINE_CASE_STUDIES_URL: ${{ vars.LINE_CASE_STUDIES_URL }}
  LINE_GUIDE_URL: ${{ vars.LINE_GUIDE_URL }}
  LINE_GIFT_URL: ${{ vars.LINE_GIFT_URL }}
  LINE_PREMIUM_URL: ${{ vars.LINE_PREMIUM_URL }}

jobs:
  handle-line-event:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Validate configuration
        uses: ./.github/actions/validate-config
        with:
          workflow: line-event.yml
        env:
          SUPABASE_URL: ${{ vars.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          MANUS_BASE_URL: ${{ vars.MANUS_BASE_URL }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NOTIFY_WEBHOOK_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
          PROGRESS_WEBHOOK_URL: ${{ secrets.PROGRESS_WEBHOOK_URL }}
          SKIP_CONFIG_VALIDATION: ${{ env.SKIP_CONFIG_VALIDATION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Manus LINE Config
        id: manus-config
        continue-on-error: true
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          MANUS_BASE_URL: ${{ vars.MANUS_BASE_URL }}
          MANUS_LINE_CONFIG_PATH: ${{ vars.MANUS_LINE_CONFIG_PATH }}
        run: |
          if [ -z "$MANUS_API_KEY" ]; then
            echo "â„¹ï¸ MANUS_API_KEY not set. Skipping Manus config fetch."
            exit 0
          fi
          node scripts/manus/export-config.mjs \
            --output tmp/manus-line-config.json \
            --path "${MANUS_LINE_CONFIG_PATH:-/v1/config/line}" || {
            echo "âš ï¸ Failed to fetch Manus config. Continuing with defaults."
            exit 0
          }

      - name: Build LINE Templates
        continue-on-error: true
        env:
          LINE_CASE_STUDIES_URL: ${{ env.LINE_CASE_STUDIES_URL }}
          LINE_GUIDE_URL: ${{ env.LINE_GUIDE_URL }}
          LINE_GIFT_URL: ${{ env.LINE_GIFT_URL }}
          LINE_PREMIUM_URL: ${{ env.LINE_PREMIUM_URL }}
        run: |
          if command -v npm &> /dev/null && [ -f package.json ]; then
            npm run line:templates || {
              echo "âš ï¸ Template build failed. Continuing without templates."
              exit 0
            }
          else
            echo "â„¹ï¸ npm not available or package.json missing. Skipping template build."
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Persist Event Payload
        id: event
        run: |
          set -euo pipefail
          mkdir -p tmp
          # Handle both repository_dispatch and workflow_dispatch
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            printf '%s\n' '${{ toJson(github.event.client_payload) }}' > tmp/event.json
          else
            # workflow_dispatch: use provided payload_path or create default
            PAYLOAD_PATH="${{ github.event.inputs.payload_path }}"
            if [ -n "$PAYLOAD_PATH" ] && [ -f "$PAYLOAD_PATH" ]; then
              echo "ðŸ“„ Using provided payload file: $PAYLOAD_PATH"
              cp "$PAYLOAD_PATH" tmp/event.json
            else
              # Create a minimal test payload
              echo "ðŸ“ Creating default test payload"
              TIMESTAMP=$(date -u +%s)
              jq -n --arg ts "$TIMESTAMP" '{
                "event_id": "test-\($ts)",
                "received_at": now | todateiso8601,
                "signature_valid": true,
                "dedupe_key": "test-dedupe-key",
                "events": [{
                  "type": "follow",
                  "timestamp": (now * 1000 | floor),
                  "source": {
                    "type": "user",
                    "userId": "test-user-id"
                  }
                }]
              }' > tmp/event.json
            fi
          fi
          EVENT_TYPE=$(jq -r '.events[0].type // "unknown"' tmp/event.json)
          USER_COUNT=$(jq '[.events[].source.userId] | unique | length' tmp/event.json 2>/dev/null || echo "0")
          echo "event_type=$EVENT_TYPE" >> "$GITHUB_OUTPUT"
          echo "user_count=$USER_COUNT" >> "$GITHUB_OUTPUT"
          echo "payload_path=tmp/event.json" >> "$GITHUB_OUTPUT"

      - name: Evaluate orchestration spec constraints
        run: |
          mkdir -p tmp/orchestration
          node scripts/orchestration/evaluate-line-event.mjs \
            --event "${{ steps.event.outputs.payload_path }}" \
            --spec codex.spec.yaml \
            --output tmp/orchestration/spec-evaluation.json || {
            echo "âš ï¸ Spec evaluation failed. Continuing without template dispatch."
            exit 0
          }

      - name: Dispatch LINE replies
        continue-on-error: true
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          DEVELOPMENT_MODE: ${{ vars.DEVELOPMENT_MODE }}
          LINE_CASE_STUDIES_URL: ${{ env.LINE_CASE_STUDIES_URL }}
          LINE_GUIDE_URL: ${{ env.LINE_GUIDE_URL }}
          LINE_GIFT_URL: ${{ env.LINE_GIFT_URL }}
          LINE_PREMIUM_URL: ${{ env.LINE_PREMIUM_URL }}
        run: |
          set -euo pipefail
          if [ -z "${LINE_CHANNEL_ACCESS_TOKEN:-}" ]; then
            echo "â„¹ï¸ LINE channel access token not configured. Skipping template dispatch."
            exit 0
          fi
          if [ ! -f tmp/orchestration/spec-evaluation.json ]; then
            echo "â„¹ï¸ Spec evaluation file not found. Skipping template dispatch."
            exit 0
          fi
          DRY_RUN=""
          if [ "${DEVELOPMENT_MODE}" = "true" ]; then
            DRY_RUN="--dry-run"
          fi
          node scripts/orchestration/reply-line-templates.mjs \
            --event "${{ steps.event.outputs.payload_path }}" \
            --evaluation tmp/orchestration/spec-evaluation.json \
            --templates config/line/templates \
            --token "$LINE_CHANNEL_ACCESS_TOKEN" \
            $DRY_RUN || {
            echo "âš ï¸ Template dispatch failed. Continuing workflow."
            exit 0
          }

      - name: Ensure Plan Directories
        run: |
          mkdir -p orchestration/plan
          mkdir -p orchestration/plan/production

      - name: Resolve Plan Mode
        id: mode
        run: |
          set -euo pipefail
          MODE="normal"
          REASON="none"
          if [ "${{ vars.MANUS_ENABLED }}" = "false" ]; then
            MODE="degraded"
            REASON="manus_disabled"
          fi
          if [ "${{ vars.DEGRADED_MODE }}" = "true" ]; then
            MODE="degraded"
            REASON="forced_variable"
          fi
          if [ -f "$DEGRADED_FLAG_PATH" ]; then
            MODE="degraded"
            REASON="flag_file_present"
          fi
          SOURCE="$PRODUCTION_PLAN_PATH"
          WARNING=""
          if [ "$MODE" = "degraded" ]; then
            if [ -f "$DEGRADED_PLAN_PATH" ]; then
              SOURCE="$DEGRADED_PLAN_PATH"
            else
              WARNING="degraded_plan_missing"
              SOURCE="$PRODUCTION_PLAN_PATH"
              REASON="plan_missing"
              echo "âš ï¸ Degraded mode requested but $DEGRADED_PLAN_PATH not found. Falling back to current plan." >&2
            fi
          fi
          echo "mode=$MODE" >> "$GITHUB_OUTPUT"
          echo "plan_source=$SOURCE" >> "$GITHUB_OUTPUT"
          echo "warning=$WARNING" >> "$GITHUB_OUTPUT"
          echo "degraded_reason=$REASON" >> "$GITHUB_OUTPUT"

      - name: Generate PlanDelta (Development Only)
        if: vars.DEVELOPMENT_MODE == 'true'
        continue-on-error: true
        run: |
          if [ ! -f scripts/plan/generate-plan-delta.js ]; then
            echo "âš ï¸ generate-plan-delta.js not found. Skipping plan delta generation."
            exit 0
          fi
          node scripts/plan/generate-plan-delta.js \
            --event tmp/event.json \
            --plan "$PLAN_CURRENT_PATH" \
            --delta "$PLAN_DELTA_PATH" || {
            echo "âš ï¸ Plan delta generation failed. Continuing workflow."
            exit 0
          }

      - name: Load Selected Plan (Production)
        if: vars.DEVELOPMENT_MODE != 'true'
        run: |
          set -euo pipefail
          SOURCE="${{ steps.mode.outputs.plan_source }}"
          if [ ! -f "$SOURCE" ]; then
            echo "âŒ Plan file not found at $SOURCE"
            exit 1
          fi
          cp "$SOURCE" "$PLAN_CURRENT_PATH"
          rm -f "$PLAN_DELTA_PATH"
          echo "âœ… Loaded plan from $SOURCE"

      - name: Verify Plan File Exists
        run: |
          set -euo pipefail
          if [ ! -f "$PLAN_CURRENT_PATH" ]; then
            echo "âŒ Plan file not found: $PLAN_CURRENT_PATH"
            exit 1
          fi
          jq '.' "$PLAN_CURRENT_PATH" > /dev/null
          echo "âœ… Plan ready at $PLAN_CURRENT_PATH"

      - name: Verify degraded assets
        if: steps.mode.outputs.mode == 'degraded'
        run: |
          set -euo pipefail
          if [ ! -f docs/alerts/line_degraded_outreach.ics ]; then
            echo "âŒ Expected docs/alerts/line_degraded_outreach.ics to exist for degraded workflow."
            exit 1
          fi
          echo "âœ… Degraded ICS asset available"

      - name: Estimate Plan Cost
        id: cost
        run: |
          set -euo pipefail
          mkdir -p tmp
          python orchestration/cost.py "$PLAN_CURRENT_PATH" > tmp/cost.json
          cat tmp/cost.json
          WITHIN=$(jq -r '.within_budget' tmp/cost.json)
          echo "within_budget=$WITHIN" >> "$GITHUB_OUTPUT"
          if [ "$WITHIN" != "true" ]; then
            echo "âš ï¸ Budget warning: $(jq -r '.recommendation' tmp/cost.json)"
          fi

      - name: Upsert events into Supabase
        id: supabase
        continue-on-error: true
        env:
          SUPABASE_URL: ${{ vars.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          PLAN_MODE: ${{ steps.mode.outputs.mode }}
        run: |
          set -euo pipefail
          OUTPUT=$(node scripts/vendor/supabase/upsert-line-event.js \
            "${{ steps.event.outputs.payload_path }}" \
            "$PLAN_CURRENT_PATH" \
            "${{ github.run_id }}:${{ github.run_attempt }}" 2>&1 || true)
          echo "$OUTPUT" | tee tmp/supabase-line.json
          STATUS=$(echo "$OUTPUT" | jq -r '.status // "error"' 2>/dev/null || echo "error")
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          if [ "$STATUS" != "ok" ]; then
            echo "âš ï¸ Supabase ingest did not complete successfully (status=$STATUS)"
            echo "âš ï¸ This may be due to schema cache not being updated yet."
            echo "âš ï¸ The workflow will continue, but data may not be persisted."
          fi

      - name: Update Google Sheets ledger
        continue-on-error: true
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SHEET_NAME: line_members
        run: |
          if [ -z "$GOOGLE_SERVICE_ACCOUNT_JSON" ] || [ -z "$GOOGLE_SHEET_ID" ]; then
            echo "â„¹ï¸ Google Sheets credentials missing. Skipping ledger update."
            exit 0
          fi
          node scripts/vendor/google/upsert-line-member.js tmp/event.json || {
            echo "âš ï¸ Google Sheets update failed. This is non-critical."
            exit 0
          }

      - name: Dispatch to Manus (Development Only)
        if: vars.DEVELOPMENT_MODE == 'true' && vars.MANUS_ENABLED == 'true' && steps.mode.outputs.mode != 'degraded'
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          MANUS_BASE_URL: ${{ vars.MANUS_BASE_URL }}
          PROGRESS_WEBHOOK_URL: ${{ secrets.PROGRESS_WEBHOOK_URL }}
        run: |
          if [ -z "$MANUS_API_KEY" ]; then
            echo "âš ï¸ MANUS_API_KEY is not set. Skipping Manus API call."
            exit 0
          fi
          PLAN_FILE="$PLAN_CURRENT_PATH"
          BRIEF_FILE="orchestration/MANUS_EXECUTION_BRIEF_v2.0.txt"
          if [ ! -f "$PLAN_FILE" ]; then
            echo "âš ï¸ Plan file not found: $PLAN_FILE"
            exit 1
          fi
          if [ ! -f "$BRIEF_FILE" ]; then
            echo "âš ï¸ Brief file not found: $BRIEF_FILE"
            exit 1
          fi
          echo "ðŸš€ Calling Manus API to create task..."
          node scripts/manus-api.js create "$BRIEF_FILE" "$PLAN_FILE" --webhook "$PROGRESS_WEBHOOK_URL" || {
            echo "âŒ Failed to create Manus task"
            exit 1
          }
          echo "âœ… Manus task created successfully"

      - name: Prepare event log
        if: always()
        id: line_log
        run: |
          set -euo pipefail
          mkdir -p logs/progress
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          TARGET="logs/progress/${TIMESTAMP}_line.json"
          jq '.' tmp/event.json > "$TARGET"
          echo "path=$TARGET" >> "$GITHUB_OUTPUT"

      - name: Persist event log
        if: ${{ always() && steps.line_log.outputs.path != '' }}
        uses: ./.github/actions/persist-progress
        with:
          path: ${{ steps.line_log.outputs.path }}
          commit-message: "chore: log line event"
          artifact-label: line-event

      - name: Gemini Log Summary
        id: gemini
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_COST_PER_CALL: ${{ vars.GEMINI_COST_PER_CALL }}
        run: |
          set -euo pipefail
          mkdir -p tmp/gemini
          START_MS=$(python - <<'PY'
            import time
            print(int(time.time() * 1000))
          PY
          )
          node scripts/automation/run-gemini-log-summary.mjs \
            --input logs/progress \
            --output tmp/gemini/log-summary.json \
            --limit 50 || true
          END_MS=$(python - <<'PY'
            import time
            print(int(time.time() * 1000))
          PY
          )
          DURATION_MS=$((END_MS - START_MS))
          if [ -f tmp/gemini/log-summary.json ]; then
            STATUS=$(jq -r '.status // "unknown"' tmp/gemini/log-summary.json 2>/dev/null || echo "unknown")
            SUMMARY=$(jq -r '.summary // ""' tmp/gemini/log-summary.json 2>/dev/null || echo "")
            LATENCY=$(jq -r '.latency_ms // 0' tmp/gemini/log-summary.json 2>/dev/null || echo "0")
            COST=$(jq -r '.cost_estimate // 0' tmp/gemini/log-summary.json 2>/dev/null || echo "0")
            LOGS_COUNT=$(jq -r '.logs_count // 0' tmp/gemini/log-summary.json 2>/dev/null || echo "0")
            MODEL=$(jq -r '.model // ""' tmp/gemini/log-summary.json 2>/dev/null || echo "")
          else
            STATUS="missing"
            SUMMARY=""
            LATENCY="0"
            COST="0"
            LOGS_COUNT="0"
            MODEL=""
          fi
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          echo "duration_ms=$DURATION_MS" >> "$GITHUB_OUTPUT"
          echo "latency_ms=$LATENCY" >> "$GITHUB_OUTPUT"
          echo "cost_estimate=$COST" >> "$GITHUB_OUTPUT"
          echo "logs_count=$LOGS_COUNT" >> "$GITHUB_OUTPUT"
          if [ -n "$MODEL" ]; then
            echo "model=$MODEL" >> "$GITHUB_OUTPUT"
          fi
          if [ -n "$SUMMARY" ] && [ "$SUMMARY" != "null" ]; then
            {
              echo "summary<<EOF"
              echo "$SUMMARY"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Record Gemini Metrics
        if: always()
        env:
          METRICS_PATH: tmp/gemini/metrics.jsonl
          GEMINI_STATUS: ${{ steps.gemini.outputs.status || 'unavailable' }}
          GEMINI_DURATION: ${{ steps.gemini.outputs.duration_ms || '0' }}
          GEMINI_LATENCY: ${{ steps.gemini.outputs.latency_ms || '0' }}
          GEMINI_COST: ${{ steps.gemini.outputs.cost_estimate || '0' }}
          GEMINI_LOGS: ${{ steps.gemini.outputs.logs_count || '0' }}
          GEMINI_MODEL: ${{ steps.gemini.outputs.model || '' }}
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "$METRICS_PATH")"
          python - <<'PY' >> "$METRICS_PATH"
            import json
            import os
            from datetime import datetime, timezone


            def parse_int(value):
                try:
                    return int(float(value))
                except (TypeError, ValueError):
                    return 0


            def parse_float(value):
                try:
                    return float(value)
                except (TypeError, ValueError):
                    return 0.0


            record = {
                "run_id": f"{os.environ.get('GITHUB_RUN_ID')}:{os.environ.get('GITHUB_RUN_ATTEMPT')}",
                "timestamp": datetime.now(timezone.utc).isoformat().replace('+00:00', 'Z'),
                "status": os.environ.get('GEMINI_STATUS') or 'unavailable',
                "duration_ms": parse_int(os.environ.get('GEMINI_DURATION')),
                "latency_ms": parse_int(os.environ.get('GEMINI_LATENCY')),
                "logs_count": parse_int(os.environ.get('GEMINI_LOGS')),
                "cost_estimate": parse_float(os.environ.get('GEMINI_COST')),
                "model": os.environ.get('GEMINI_MODEL') or '',
            }
            print(json.dumps(record))
          PY
      - name: Upload Gemini Log Summary Artifact
        if: always() && steps.gemini.outputs.status
        uses: actions/upload-artifact@v4
        with:
          name: gemini-log-summary
          path: tmp/gemini/log-summary.json
          if-no-files-found: ignore

      - name: Upload Gemini Metrics Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gemini-metrics
          path: tmp/gemini/metrics.jsonl
          if-no-files-found: ignore

      - name: Notify stakeholders
        if: always()
        continue-on-error: true
        timeout-minutes: 5
        env:
          NOTIFY_WEBHOOK_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
          FALLBACK_WEBHOOK_URL: ${{ secrets.PROGRESS_WEBHOOK_URL }}
          EVENT_TYPE: ${{ steps.event.outputs.event_type }}
          SUPABASE_STATUS: ${{ steps.supabase.outputs.status || 'skipped' }}
          MODE: ${{ steps.mode.outputs.mode }}
          DEGRADED_REASON: ${{ steps.mode.outputs.degraded_reason || 'none' }}
        run: |
          if [ -z "${NOTIFY_WEBHOOK_URL:-}" ]; then
            NOTIFY_WEBHOOK_URL="${FALLBACK_WEBHOOK_URL:-}"
          fi
          if [ -z "${NOTIFY_WEBHOOK_URL:-}" ]; then
            echo "â„¹ï¸ Notification webhook not configured. Skipping."
            exit 0
          fi
          # Validate webhook URL format
          if [[ ! "$NOTIFY_WEBHOOK_URL" =~ ^https?:// ]]; then
            echo "âš ï¸ Invalid webhook URL format. Skipping."
            exit 0
          fi
          USER_COUNT="${USER_COUNT:-${{ steps.event.outputs.user_count }}}"
          MODE_VALUE="${MODE:-normal}"
          REASON_VALUE="${DEGRADED_REASON:-none}"
          EVENT_TYPE_VALUE="${EVENT_TYPE:-unknown}"
          SUPABASE_STATUS_VALUE="${SUPABASE_STATUS:-skipped}"
          if [ -f tmp/supabase-line.json ]; then
            FILE_STATUS=$(jq -r '.status // empty' tmp/supabase-line.json 2>/dev/null || true)
            if [ -n "$FILE_STATUS" ]; then
              SUPABASE_STATUS_VALUE="$FILE_STATUS"
            fi
          fi
          GEMINI_STATUS_VALUE="${{ steps.gemini.outputs.status || 'unavailable' }}"
          GEMINI_COST_VALUE="${{ steps.gemini.outputs.cost_estimate || '0' }}"
          if [ -z "$GEMINI_COST_VALUE" ]; then GEMINI_COST_VALUE="0"; fi
          if [ "$MODE_VALUE" = "degraded" ]; then
            MESSAGE=$(jq -n \
              --arg txt "[LINE][DEGRADED] event processed: type=$EVENT_TYPE_VALUE, supabase=$SUPABASE_STATUS_VALUE, gemini=$GEMINI_STATUS_VALUE (cost=$GEMINI_COST_VALUE), reason=$REASON_VALUE, users=$USER_COUNT. Refer to docs/alerts/line_degraded_outreach.ics for manual follow-up." \
              '{text: $txt}')
          else
            MESSAGE=$(jq -n \
              --arg txt "[LINE] event processed: type=$EVENT_TYPE_VALUE, supabase=$SUPABASE_STATUS_VALUE, gemini=$GEMINI_STATUS_VALUE (cost=$GEMINI_COST_VALUE), mode=$MODE_VALUE, users=$USER_COUNT" \
              '{text: $txt}')
          fi
          curl -sSf -X POST -H "Content-Type: application/json" \
            -d "$MESSAGE" "$NOTIFY_WEBHOOK_URL" || {
            echo "âš ï¸ Failed to send notification. This is non-critical."
            exit 0
          }

      - name: Summarize outcome
        if: always()
        run: |
          MODE='${{ steps.mode.outputs.mode }}'
          PLAN_WARNING='${{ steps.mode.outputs.warning }}'
          REASON='${{ steps.mode.outputs.degraded_reason }}'
          SUPABASE_STATUS='${{ steps.supabase.outputs.status || 'not-run' }}'
          GEMINI_STATUS='${{ steps.gemini.outputs.status || 'unavailable' }}'
          GEMINI_SUMMARY='${{ steps.gemini.outputs.summary || '' }}'
          GEMINI_DURATION='${{ steps.gemini.outputs.duration_ms || '' }}'
          GEMINI_LATENCY='${{ steps.gemini.outputs.latency_ms || '' }}'
          GEMINI_COST='${{ steps.gemini.outputs.cost_estimate || '' }}'
          GEMINI_LOGS='${{ steps.gemini.outputs.logs_count || '' }}'
          SUPABASE_PROGRESS=""
          if [ -f tmp/supabase-line.json ]; then
            FILE_STATUS=$(jq -r '.status // empty' tmp/supabase-line.json 2>/dev/null || true)
            if [ -n "$FILE_STATUS" ]; then
              SUPABASE_STATUS="$FILE_STATUS"
            fi
            PROGRESS_COUNT=$(jq -r '.progress_records // ""' tmp/supabase-line.json 2>/dev/null || true)
            MEMBER_COUNT=$(jq -r '.member_records // ""' tmp/supabase-line.json 2>/dev/null || true)
            EXTRA=""
            if [ -n "$PROGRESS_COUNT" ] || [ -n "$MEMBER_COUNT" ]; then
              EXTRA="progress=$([ -n "$PROGRESS_COUNT" ] && echo "$PROGRESS_COUNT" || echo "-")"
              if [ -n "$MEMBER_COUNT" ]; then
                EXTRA="$EXTRA, members=$MEMBER_COUNT"
              fi
              SUPABASE_PROGRESS="$EXTRA"
            fi
          fi
          COST_WITHIN='${{ steps.cost.outputs.within_budget || 'unknown' }}'
          echo "### LINE Event Handler" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "$PLAN_WARNING" ]; then
            echo "- Mode: \`$MODE\` (warning: $PLAN_WARNING)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Mode: \`$MODE\`" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ "$MODE" = "degraded" ] && [ "$REASON" != "none" ]; then
            echo "  - Degraded reason: \`$REASON\`" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ -n "$SUPABASE_PROGRESS" ]; then
            echo "- Supabase ingest: \`$SUPABASE_STATUS\` ($SUPABASE_PROGRESS)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Supabase ingest: \`$SUPABASE_STATUS\`" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ -z "$GEMINI_DURATION" ]; then GEMINI_DURATION="n/a"; fi
          if [ -z "$GEMINI_LATENCY" ]; then GEMINI_LATENCY="n/a"; fi
          if [ -z "$GEMINI_COST" ]; then GEMINI_COST="0"; fi
          if [ -z "$GEMINI_LOGS" ]; then GEMINI_LOGS="0"; fi
          echo "- Gemini log summary: \`$GEMINI_STATUS\` (duration=${GEMINI_DURATION}ms, latency=${GEMINI_LATENCY}ms, cost=${GEMINI_COST}, logs=${GEMINI_LOGS})" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "$GEMINI_SUMMARY" ]; then
            TRUNCATED=$(echo "$GEMINI_SUMMARY" | head -c 200)
            echo "  - $TRUNCATED" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$GEMINI_STATUS" = "skipped_missing_key" ]; then
            echo "  - Gemini API key not configured" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "- Plan within budget: \`$COST_WITHIN\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Event type: \`${{ steps.event.outputs.event_type }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Users processed: \`${{ steps.event.outputs.user_count }}\`" >> "$GITHUB_STEP_SUMMARY"
