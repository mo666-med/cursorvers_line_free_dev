# .github/workflows/replenish-cards.yml
# ã‚«ãƒ¼ãƒ‰åœ¨åº«ä¸è¶³æ™‚ã«AIã§è‡ªå‹•è£œå……
# å¤±æ•—æ™‚: ãƒªãƒˆãƒ©ã‚¤ â†’ Manusåˆ†æ â†’ GitHub Issueä½œæˆ

name: Replenish Cards (AI)

on:
  workflow_dispatch:
    inputs:
      themes:
        description: 'è£œå……ã™ã‚‹ãƒ†ãƒ¼ãƒï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰'
        required: false
        default: 'tax,career,general'
        type: string
      count:
        description: 'ãƒ†ãƒ¼ãƒã”ã¨ã®ç”Ÿæˆæ•°'
        required: false
        default: '20'
        type: string
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  workflow_call:
    inputs:
      themes:
        required: true
        type: string
      count:
        required: false
        type: string
        default: '20'

permissions:
  contents: read
  issues: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x

      - name: Generate and insert cards (with retry)
        id: generate
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 3
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            cd scripts/generate-cards

            THEMES="${{ inputs.themes || 'tax,career,general' }}"
            COUNT="${{ inputs.count || '20' }}"
            DRY_RUN="${{ inputs.dry_run || 'false' }}"

            OPTS="--themes=${THEMES} --count=${COUNT}"
            if [ "$DRY_RUN" = "true" ]; then
              OPTS="$OPTS --dry-run"
            fi

            echo "Running: deno run main.ts $OPTS"
            deno run --allow-env --allow-net --no-lock main.ts $OPTS
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Notify Discord on success
        if: success() && inputs.dry_run != 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            TIMESTAMP=$(TZ=Asia/Tokyo date +"%Y-%m-%d %H:%M JST")
            curl -s -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"embeds\": [{\"title\": \"âœ… AI ã‚«ãƒ¼ãƒ‰è‡ªå‹•è£œå……å®Œäº†\", \"color\": 5763719, \"fields\": [{\"name\": \"ãƒ†ãƒ¼ãƒ\", \"value\": \"${{ inputs.themes || 'tax,career,general' }}\", \"inline\": true}, {\"name\": \"ç”Ÿæˆæ•°/ãƒ†ãƒ¼ãƒ\", \"value\": \"${{ inputs.count || '20' }}\", \"inline\": true}, {\"name\": \"æ—¥æ™‚\", \"value\": \"${TIMESTAMP}\", \"inline\": true}], \"footer\": {\"text\": \"AI Card Generator\"}}]}"
          fi

      # ========================================
      # å¤±æ•—æ™‚: Manusåˆ†æ â†’ GitHub Issueä½œæˆ
      # ========================================
      - name: Request Manus analysis on failure
        if: always() && steps.generate.outcome == 'failure'
        id: manus
        continue-on-error: true
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
        run: |
          if [ -z "$MANUS_API_KEY" ]; then
            echo "MANUS_API_KEY not set, skipping Manus analysis"
            echo "manus_triggered=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ã‚¨ãƒ©ãƒ¼åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå®Ÿè¡Œã¯æ±‚ã‚ãªã„ï¼‰
          PROMPT=$(cat <<'PROMPT_EOF'
          # AIã‚«ãƒ¼ãƒ‰è‡ªå‹•è£œå……ã‚¨ãƒ©ãƒ¼åˆ†æ

          GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€ŒReplenish Cards (AI)ã€ãŒ3å›ãƒªãƒˆãƒ©ã‚¤å¾Œã‚‚å¤±æ•—ã—ã¾ã—ãŸã€‚

          ## ã‚¨ãƒ©ãƒ¼æƒ…å ±
          - ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
          - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - ãƒ†ãƒ¼ãƒ: ${{ inputs.themes || 'tax,career,general' }}
          - ç”Ÿæˆæ•°: ${{ inputs.count || '20' }}

          ## ä¾é ¼äº‹é …ï¼ˆåˆ†æã®ã¿ï¼‰
          1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã€ã‚¨ãƒ©ãƒ¼ã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®šã—ã¦ãã ã•ã„
          2. è€ƒãˆã‚‰ã‚Œã‚‹åŸå› ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„
          3. æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£æ–¹æ³•ã‚’ææ¡ˆã—ã¦ãã ã•ã„

          **æ³¨æ„**: å®Ÿè¡Œã‚„ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã¯è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚åˆ†æçµæœã®ã¿ã‚’å ±å‘Šã—ã¦ãã ã•ã„ã€‚
          PROMPT_EOF
          )

          RESPONSE=$(curl -s -X POST "https://api.manus.ai/v1/tasks" \
            -H "Content-Type: application/json" \
            -H "API_KEY: $MANUS_API_KEY" \
            -d "{\"prompt\": $(echo "$PROMPT" | jq -Rs .), \"agentProfile\": \"manus-1.6-lite\", \"taskMode\": \"chat\", \"locale\": \"ja\"}")

          TASK_ID=$(echo "$RESPONSE" | jq -r '.task_id // empty')
          TASK_URL=$(echo "$RESPONSE" | jq -r '.task_url // empty')

          if [ -n "$TASK_ID" ]; then
            echo "Manus task created: $TASK_URL"
            echo "manus_triggered=true" >> $GITHUB_OUTPUT
            echo "task_url=$TASK_URL" >> $GITHUB_OUTPUT
          else
            echo "Failed to create Manus task"
            echo "manus_triggered=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Issue on failure
        if: always() && steps.generate.outcome == 'failure'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TIMESTAMP=$(TZ=Asia/Tokyo date +"%Y-%m-%d %H:%M JST")
          MANUS_URL="${{ steps.manus.outputs.task_url }}"

          BODY=$(cat <<EOF
          ## æ¦‚è¦
          AIã‚«ãƒ¼ãƒ‰è‡ªå‹•è£œå……ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒ3å›ãƒªãƒˆãƒ©ã‚¤å¾Œã‚‚å¤±æ•—ã—ã¾ã—ãŸã€‚

          ## ã‚¨ãƒ©ãƒ¼æƒ…å ±
          - **æ—¥æ™‚**: ${TIMESTAMP}
          - **ãƒ†ãƒ¼ãƒ**: ${{ inputs.themes || 'tax,career,general' }}
          - **ç”Ÿæˆæ•°/ãƒ†ãƒ¼ãƒ**: ${{ inputs.count || '20' }}
          - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Manusåˆ†æ
          ${MANUS_URL:+- **åˆ†æã‚¿ã‚¹ã‚¯**: $MANUS_URL}
          ${MANUS_URL:-Manus APIæœªè¨­å®šã®ãŸã‚åˆ†æãªã—}

          ## å¯¾å¿œæ‰‹é †
          1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
          2. ã‚¨ãƒ©ãƒ¼åŸå› ã‚’ç‰¹å®š
          3. ä¿®æ­£å¾Œã€æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œ

          \`\`\`bash
          gh workflow run replenish-cards.yml -f themes="${{ inputs.themes || 'tax,career,general' }}" -f count="${{ inputs.count || '20' }}"
          \`\`\`
          EOF
          )

          gh issue create \
            --title "ğŸš¨ AIã‚«ãƒ¼ãƒ‰è‡ªå‹•è£œå……å¤±æ•— (${TIMESTAMP})" \
            --body "$BODY" \
            --label "bug,auto-generated"

      - name: Notify Discord on failure
        if: always() && steps.generate.outcome == 'failure'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            TIMESTAMP=$(TZ=Asia/Tokyo date +"%Y-%m-%d %H:%M JST")
            MANUS_URL="${{ steps.manus.outputs.task_url }}"
            MANUS_INFO=""
            if [ -n "$MANUS_URL" ]; then
              MANUS_INFO=", {\"name\": \"Manusåˆ†æ\", \"value\": \"[View](${MANUS_URL})\", \"inline\": true}"
            fi

            curl -s -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"embeds\": [{\"title\": \"âŒ AI ã‚«ãƒ¼ãƒ‰è‡ªå‹•è£œå……å¤±æ•—ï¼ˆ3å›ãƒªãƒˆãƒ©ã‚¤å¾Œï¼‰\", \"color\": 15158332, \"description\": \"GitHub Issue ã‚’ä½œæˆã—ã¾ã—ãŸã€‚Manus ãŒåŸå› åˆ†æä¸­ã§ã™ã€‚\", \"fields\": [{\"name\": \"ãƒ†ãƒ¼ãƒ\", \"value\": \"${{ inputs.themes || 'tax,career,general' }}\", \"inline\": true}, {\"name\": \"æ—¥æ™‚\", \"value\": \"${TIMESTAMP}\", \"inline\": true}, {\"name\": \"ãƒ­ã‚°\", \"value\": \"[View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": true}${MANUS_INFO}], \"footer\": {\"text\": \"AI Card Generator\"}}]}"
          fi
