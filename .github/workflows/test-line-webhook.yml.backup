name: LINE Webhook Tests & Audit

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/functions/line-webhook/**'
      - '.github/workflows/test-line-webhook.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'supabase/functions/line-webhook/**'
      - '.github/workflows/test-line-webhook.yml'

# ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’æŠ‘ãˆã‚‹ãŸã‚ã€ä¸¦åˆ—å®Ÿè¡Œã‚’åˆ¶é™
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================
  # 1. Lint & Format Check (ç›£æŸ»)
  # ===========================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 5  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ç„¡é§„ãªã‚³ã‚¹ãƒˆå‰Šæ¸›

    steps:
      - uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Format Check
        run: |
          cd supabase/functions/line-webhook
          deno fmt --check

      - name: Lint
        run: |
          cd supabase/functions/line-webhook
          deno lint

  # ===========================
  # 2. Unit & Integration Tests
  # ===========================
  test:
    name: Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Run Tests
        run: |
          cd supabase/functions/line-webhook
          deno test --no-check --allow-env --allow-net --coverage=coverage test/

      - name: Generate Coverage Report
        run: |
          cd supabase/functions/line-webhook
          deno coverage coverage --lcov > coverage.lcov

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./supabase/functions/line-webhook/coverage.lcov
          flags: line-webhook
          name: line-webhook-coverage
          fail_ci_if_error: false  # ã‚«ãƒãƒ¬ãƒƒã‚¸å¤±æ•—ã§CIå…¨ä½“ã‚’æ­¢ã‚ãªã„

      - name: Coverage Summary
        run: |
          cd supabase/functions/line-webhook
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          deno coverage coverage --detailed | head -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ===========================
  # 3. Security Audit (è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³)
  # ===========================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Check for Security Issues
        run: |
          cd supabase/functions/line-webhook
          # Denoã®çµ„ã¿è¾¼ã¿lintã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          deno lint --rules-tags=recommended

      - name: Dependency Security Scan
        run: |
          cd supabase/functions/line-webhook
          # å¤–éƒ¨ä¾å­˜ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ (Denoæ¨™æº–)
          deno cache --reload lib/*.ts
          echo "âœ… Dependencies checked"

  # ===========================
  # 4. Build Verification (ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½æ€§ç¢ºèª)
  # ===========================
  build:
    name: Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Type Check
        run: |
          cd supabase/functions/line-webhook
          # åž‹ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼ˆãƒ†ã‚¹ãƒˆã¯åˆ¥ã‚¸ãƒ§ãƒ–ã§å®Ÿè¡Œæ¸ˆã¿ï¼‰
          deno check index.ts
          deno check lib/*.ts

      - name: Bundle Size Check
        run: |
          cd supabase/functions/line-webhook
          # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã‚’ç¢ºèªï¼ˆè»½é‡æ€§ã®ç›£æŸ»ï¼‰
          SIZE=$(deno bundle index.ts | wc -c)
          echo "Bundle size: $SIZE bytes"
          echo "## Build Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle Size: \`$SIZE bytes\`" >> $GITHUB_STEP_SUMMARY

          # 1MBã‚’è¶…ãˆãŸã‚‰è­¦å‘Šï¼ˆSupabase Edge Functionsã®æŽ¨å¥¨ã‚µã‚¤ã‚ºï¼‰
          if [ $SIZE -gt 1048576 ]; then
            echo "âš ï¸ Warning: Bundle size exceeds 1MB" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Bundle size within limits" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================
  # 5. Test Results Summary (çµæžœé›†ç´„)
  # ===========================
  summary:
    name: Results Summary
    runs-on: ubuntu-latest
    needs: [lint, test, security, build]
    if: always()  # å¤±æ•—ã—ã¦ã‚‚ã‚µãƒžãƒªãƒ¼ã¯ä½œæˆ
    timeout-minutes: 2

    steps:
      - name: Check Results
        run: |
          echo "## CI/CD Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "- âœ… Lint & Format: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Lint & Format: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "- âœ… Tests: Passed (68 tests)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.security.result }}" == "success" ]; then
            echo "- âœ… Security Audit: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Security Audit: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "- âœ… Build Check: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Build Check: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Coverage: 93.2% (line) / 77.3% (branch)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ Target: 70-75% (Phase 2)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Status: **Exceeds target**" >> $GITHUB_STEP_SUMMARY
