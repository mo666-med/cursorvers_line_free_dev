name: Weekly Reports (Unified)

# Generates both KPI report (to Discussions) and Agent report (to Issues)
# Runs every Monday at 9:00 AM UTC (6:00 PM JST)

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9:00 AM UTC
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type to generate'
        required: false
        default: 'both'
        type: choice
        options:
          - 'both'
          - 'kpi'
          - 'agent'

permissions:
  issues: write
  contents: read

jobs:
  kpi-report:
    if: |
      github.event_name == 'schedule' ||
      inputs.report_type == 'both' ||
      inputs.report_type == 'kpi'
    runs-on: ubuntu-latest
    name: Generate KPI Report

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Generate and Post KPI Report
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          cat > post-kpi-report.ts << 'EOF'
          import { ProjectsV2Client } from './agents/github/projects-v2.js';
          import { DiscussionsClient } from './agents/github/discussions.js';

          async function main() {
            const token = process.env.GITHUB_TOKEN!;
            const [owner, repo] = process.env.GITHUB_REPOSITORY!.split('/');

            // Initialize clients
            const projectsClient = new ProjectsV2Client(token, {
              owner,
              repo,
              projectNumber: parseInt(process.env.GITHUB_PROJECT_NUMBER || '1'),
            });

            const discussionsClient = new DiscussionsClient(token, {
              owner,
              repo,
            });

            // Initialize both clients
            await projectsClient.initialize();
            await discussionsClient.initialize();

            // Generate KPI report
            console.log('ðŸ“Š Generating KPI report...');
            const kpiData = await projectsClient.generateKPIReport();

            console.log('KPI Data:', kpiData);

            // Post to Discussions
            console.log('ðŸ“ Posting to GitHub Discussions...');
            const discussion = await discussionsClient.postWeeklyKPIReport(kpiData);

            console.log(`âœ“ Posted weekly KPI report: ${discussion.url}`);
            console.log(`  Discussion #${discussion.number}: ${discussion.title}`);
          }

          main().catch((error) => {
            console.error('Error generating KPI report:', error);
            process.exit(1);
          });
          EOF

          npx tsx post-kpi-report.ts

      - name: Summary
        run: |
          echo "### ðŸ“Š Weekly KPI Report Posted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ“ Successfully generated and posted weekly KPI report to Discussions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View at: https://github.com/${{ github.repository }}/discussions" >> $GITHUB_STEP_SUMMARY

  agent-report:
    if: |
      github.event_name == 'schedule' ||
      inputs.report_type == 'both' ||
      inputs.report_type == 'agent'
    runs-on: ubuntu-latest
    name: Generate Agent Report

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate weekly report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
          PROJECT_NUMBER: 1
        run: npm run report:weekly:issue

      - name: Log completion
        run: |
          echo "âœ… Weekly agent report generated"
          echo "   Repository: ${{ github.repository }}"
          echo "   Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
