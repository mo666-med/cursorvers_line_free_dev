# 開発歴
# - 2026-01-09: LINE Bot署名検証スモークテスト追加。
name: LINE Bot Smoke Test

on:
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Smoke test signed POST
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          STRIPE_WEBHOOK_SECRET: smoke-test-secret
          STRIPE_WEBHOOK_SMOKE_MODE: "true"
          STRIPE_API_KEY: sk_test_smoke
          DISCORD_WEBHOOK_URL: https://example.com
          DISCORD_SYSTEM_WEBHOOK: https://example.com
        run: |
          set -euo pipefail
          : "${LINE_CHANNEL_ACCESS_TOKEN:?LINE_CHANNEL_ACCESS_TOKEN missing}"
          : "${LINE_CHANNEL_SECRET:?LINE_CHANNEL_SECRET missing}"
          : "${SUPABASE_URL:?SUPABASE_URL missing}"
          : "${SUPABASE_SERVICE_ROLE_KEY:?SUPABASE_SERVICE_ROLE_KEY missing}"

          line_body='{"events":[]}'
          line_signature=$(printf "%s" "$line_body" | openssl dgst -sha256 -hmac "$LINE_CHANNEL_SECRET" -binary | openssl base64 -A)

          run_line_smoke() {
            local name="$1"
            local file="$2"
            local log_file="/tmp/${name}.log"
            local body_file="/tmp/${name}-body.txt"

            deno run --allow-env --allow-net "$file" >"$log_file" 2>&1 &
            local pid=$!

            local status=000
            for i in 1 2 3 4 5; do
              sleep 1
              status=$(curl -s -o "$body_file" -w "%{http_code}" \
                -H "x-line-signature: $line_signature" \
                -H "content-type: application/json" \
                -d "$line_body" \
                http://localhost:8000/ || true)
              if [ "$status" != "000" ]; then
                break
              fi
            done

            kill "$pid" 2>/dev/null || true
            wait "$pid" 2>/dev/null || true

            if [ "$status" != "200" ]; then
              echo "${name}: Unexpected status: $status"
              echo "Response:"
              cat "$body_file" || true
              echo "Log:"
              tail -n 50 "$log_file" || true
              exit 1
            fi

            local response_body
            response_body=$(cat "$body_file" || true)
            if [ "$response_body" != "OK" ]; then
              echo "${name}: Unexpected body: $response_body"
              exit 1
            fi
          }

          run_stripe_smoke() {
            local name="$1"
            local file="$2"
            local log_file="/tmp/${name}.log"
            local body_file="/tmp/${name}-body.txt"
            local timestamp
            local payload
            local signature
            local stripe_header

            timestamp=$(date +%s)
            payload="${timestamp}.${stripe_body}"
            signature=$(printf "%s" "$payload" | openssl dgst -sha256 -hmac "$STRIPE_WEBHOOK_SECRET" -hex | sed 's/^.* //')
            stripe_header="t=${timestamp},v1=${signature}"

            deno run --allow-env --allow-net "$file" >"$log_file" 2>&1 &
            local pid=$!

            local status=000
            for i in 1 2 3 4 5; do
              sleep 1
              status=$(curl -s -o "$body_file" -w "%{http_code}" \
                -H "Stripe-Signature: $stripe_header" \
                -H "x-smoke-test: true" \
                -H "content-type: application/json" \
                -d "$stripe_body" \
                http://localhost:8000/ || true)
              if [ "$status" != "000" ]; then
                break
              fi
            done

            kill "$pid" 2>/dev/null || true
            wait "$pid" 2>/dev/null || true

            if [ "$status" != "200" ]; then
              echo "${name}: Unexpected status: $status"
              echo "Response:"
              cat "$body_file" || true
              echo "Log:"
              tail -n 50 "$log_file" || true
              exit 1
            fi
          }

          stripe_body='{"id":"evt_smoke","object":"event","type":"test.event","data":{"object":{}}}'

          run_line_smoke "line-bot" "supabase/functions/line-bot/index.ts"
          run_line_smoke "line-webhook" "supabase/functions/line-webhook/index.ts"
          run_stripe_smoke "stripe-webhook" "supabase/functions/stripe-webhook/index.ts"
