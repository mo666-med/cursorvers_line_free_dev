name: Manus API Inquiry

on:
  workflow_dispatch:
    inputs:
      create_issue:
        description: 'Create GitHub Issue with results'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  issues: write

jobs:
  inquire-api:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Debug Secrets
        run: |
          echo "MANUS_API_KEY length: ${#MANUS_API_KEY}"
          echo "MANUS_BASE_URL: ${MANUS_BASE_URL:-<not-set>}"
        shell: bash
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          MANUS_BASE_URL: ${{ vars.MANUS_BASE_URL }}

      - name: Run Manus API Inquiry
        id: inquiry
        continue-on-error: true
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
          MANUS_BASE_URL: ${{ vars.MANUS_BASE_URL }}
        run: |
          node scripts/manus/inquire-api.mjs
        working-directory: .

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manus-api-inquiry-results
          path: |
            tmp/manus-inquiry-results.json
            tmp/manus-inquiry-summary.md
          retention-days: 90

      - name: Create GitHub Issue
        if: always() && github.event.inputs.create_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let summary = '';
            try {
              summary = fs.readFileSync('tmp/manus-inquiry-summary.md', 'utf8');
            } catch (error) {
              summary = '## å•ã„åˆã‚ã›çµæžœ\n\nçµæžœãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            }
            
            const resultsPath = 'tmp/manus-inquiry-results.json';
            let resultsJson = {};
            try {
              resultsJson = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            } catch (error) {
              // Ignore
            }
            
            const title = `[Manus APIå•ã„åˆã‚ã›] ${new Date().toISOString().split('T')[0]}`;
            const body = `${summary}\n\n---\n\n**å®Ÿè¡Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [View Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n**å®Ÿè¡Œæ—¥æ™‚**: ${resultsJson.timestamp || new Date().toISOString()}\n\n## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—\n\n1. çµæžœã‚’ç¢ºèªã—ã€æ­£ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç‰¹å®š\n2. \`scripts/lib/manus-api.js\`ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆURLã‚’æ›´æ–°\n3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°\n4. GitHub Variables/Secretsã‚’è¨­å®š`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['manus-api', 'inquiry', 'devops']
            });

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ” Manus APIå•ã„åˆã‚ã›å®Œäº†" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -f tmp/manus-inquiry-results.json ]; then
            echo "âœ… çµæžœãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ" >> "$GITHUB_STEP_SUMMARY"
            echo "- JSON: \`tmp/manus-inquiry-results.json\`" >> "$GITHUB_STEP_SUMMARY"
            echo "- Markdown: \`tmp/manus-inquiry-summary.md\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ çµæžœãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "è©³ç´°ã¯Artifactã¾ãŸã¯Issueã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> "$GITHUB_STEP_SUMMARY"

