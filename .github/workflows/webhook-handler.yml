name: ðŸ”” Webhook Event Handler
x-owner: devops

# Central event router for GitHub OS Event Bus
# Consolidated router delegates state changes to scripts/webhook-router.mjs

on:
  issues:
    types: [opened, labeled, closed, assigned, milestoned, reopened]
  pull_request:
    types: [opened, synchronize, closed, review_requested]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  push:
    branches: [main]
  workflow_run:
    workflows: ["*"]
    types: [completed]

permissions:
  issues: write
  pull-requests: write
  actions: write
  contents: read

jobs:
  route-event:
    runs-on: ubuntu-latest
    name: Route Event to Appropriate Handler

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Record event summary
        run: |
          echo "ðŸ”” Webhook Event: ${{ github.event_name }}.${{ github.event.action || 'default' }}"
          {
            echo "## Event Summary";
            echo "";
            echo "- Event: \`${{ github.event_name }}\`";
            echo "- Action: \`${{ github.event.action || 'n/a' }}\`";
            echo "- Actor: \`${{ github.actor }}\`";
            echo "- Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)";
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Route issue state
        if: github.event_name == 'issues'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_LABELS: ${{ toJSON(github.event.issue.labels) }}
          LABEL_NAME: ${{ github.event.label.name }}
        run: |
          node scripts/webhook-router.mjs issue "${{ github.event.action }}" "${{ github.event.issue.number }}"

      - name: Route issue comment commands
        if: github.event_name == 'issue_comment' && github.event.action == 'created'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_LABELS: ${{ toJSON(github.event.issue.labels) }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
        run: |
          node scripts/webhook-router.mjs comment "${{ github.event.action }}" "${{ github.event.issue.number }}"

      - name: No-op for unhandled events
        if: |
          github.event_name != 'issues' &&
          !(github.event_name == 'issue_comment' && github.event.action == 'created')
        run: |
          echo "No routing rules for ${{ github.event_name }}.${{ github.event.action || 'default' }}"
