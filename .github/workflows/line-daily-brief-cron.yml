# .github/workflows/line-daily-brief-cron.yml
# æ¯æ—¥1å› LINE Daily Brief ã‚’é…ä¿¡ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

name: LINE Daily Brief

on:
  schedule:
    # æ¯æ—¥ JST 07:00 (UTC 22:00 å‰æ—¥) ã«é…ä¿¡
    - cron: '0 22 * * *'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

concurrency:
  group: line-daily-brief
  cancel-in-progress: true

jobs:
  send-daily-brief:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Trigger line-daily-brief Edge Function
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸ“¤ LINE Daily Brief ã‚’é…ä¿¡ä¸­..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${SUPABASE_URL}/functions/v1/line-daily-brief" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ Edge Function returned $HTTP_CODE"
            exit 1
          fi

          # no_card ã®å ´åˆã‚‚ã‚¨ãƒ©ãƒ¼ã«ã—ãªã„
          STATUS=$(echo "$BODY" | jq -r '.status // empty')
          if [ "$STATUS" = "no_card" ]; then
            echo "ğŸ“­ é…ä¿¡å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆæ­£å¸¸çµ‚äº†ï¼‰"
          elif [ "$STATUS" = "success" ]; then
            echo "âœ… LINE Daily Brief é…ä¿¡æˆåŠŸ"
          else
            echo "âš ï¸ äºˆæœŸã—ãªã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS"
          fi

      - name: Notify on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{"content": "âš ï¸ **LINE Daily Brief ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸ**\nhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
          fi
