# .github/workflows/manus-audit-daily.yml
# æ—¥æ¬¡ç›£æŸ»: ã‚«ãƒ¼ãƒ‰åœ¨åº«ãƒ»é…ä¿¡æˆåŠŸç‡ + ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ç‚¹æ¤œ

name: Manus Audit (Daily)

on:
  schedule:
    # æ¯æ—¥ 04:00 JST (19:00 UTCå‰æ—¥)
    - cron: '0 19 * * *'
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆæ“¬ä¼¼ã‚¨ãƒ©ãƒ¼ã§è‡ªå‹•ä¿®ç¹•ã‚’ãƒ†ã‚¹ãƒˆï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write

jobs:
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # 1. Supabase Edge Functionç›£æŸ»
      # ========================================
      - name: Run Supabase audit
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          MANUS_AUDIT_API_KEY: ${{ secrets.MANUS_AUDIT_API_KEY }}
          TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        run: |
          echo "ğŸ” Supabaseç›£æŸ»ã‚’å®Ÿè¡Œä¸­..."

          # ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
          TEST_PARAM=""
          if [ "$TEST_MODE" = "true" ]; then
            echo "ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: æ“¬ä¼¼ã‚¨ãƒ©ãƒ¼ã‚’æ³¨å…¥"
            TEST_PARAM="&test=true"
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${SUPABASE_URL}/functions/v1/manus-audit-line-daily-brief?mode=daily${TEST_PARAM}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${MANUS_AUDIT_API_KEY}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ Supabaseç›£æŸ»ãŒå¤±æ•—ã—ã¾ã—ãŸ (HTTP $HTTP_CODE)"
            echo "SUPABASE_AUDIT_FAILED=true" >> $GITHUB_ENV
          else
            # Check if there are warnings or errors
            ALL_PASSED=$(echo "$BODY" | jq -r '.summary.allPassed // false')
            WARNING_COUNT=$(echo "$BODY" | jq -r '.summary.warningCount // 0')
            ERROR_COUNT=$(echo "$BODY" | jq -r '.summary.errorCount // 0')
            
            if [ "$ALL_PASSED" = "true" ]; then
              echo "âœ… Supabaseç›£æŸ»å®Œäº†: å…¨ã¦æ­£å¸¸"
              echo "SUPABASE_AUDIT_STATUS=success" >> $GITHUB_ENV
            else
              echo "âš ï¸ Supabaseç›£æŸ»å®Œäº†: ${WARNING_COUNT}ä»¶ã®è­¦å‘Šã€${ERROR_COUNT}ä»¶ã®ã‚¨ãƒ©ãƒ¼"
              echo "SUPABASE_AUDIT_STATUS=warning" >> $GITHUB_ENV
              echo "SUPABASE_WARNING_COUNT=${WARNING_COUNT}" >> $GITHUB_ENV
              echo "SUPABASE_ERROR_COUNT=${ERROR_COUNT}" >> $GITHUB_ENV
              
              if [ "$ERROR_COUNT" -gt 0 ]; then
                echo "SUPABASE_AUDIT_FAILED=true" >> $GITHUB_ENV
              fi
            fi
          fi

      # ========================================
      # 2. ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ç‚¹æ¤œï¼ˆdaily-check.shï¼‰
      # ========================================
      - name: Run system check
        env:
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          N8N_INSTANCE_URL: ${{ secrets.N8N_INSTANCE_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "ğŸ” ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ç‚¹æ¤œã‚’å®Ÿè¡Œä¸­..."
          chmod +x ./scripts/daily-check.sh
          
          if ./scripts/daily-check.sh; then
            echo "âœ… ã‚·ã‚¹ãƒ†ãƒ ç‚¹æ¤œå®Œäº†: å…¨ã¦æ­£å¸¸"
            echo "SYSTEM_CHECK_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ ã‚·ã‚¹ãƒ†ãƒ ç‚¹æ¤œã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "SYSTEM_CHECK_STATUS=failed" >> $GITHUB_ENV
            echo "SYSTEM_CHECK_FAILED=true" >> $GITHUB_ENV
          fi

      # ========================================
      # 3. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      # ========================================
      - name: Commit and push logs
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add docs/logs/
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if ! git diff --staged --quiet; then
            git commit -m "docs: Add daily audit and system check log ($(date -u +%Y-%m-%d))"
            
            # ãƒ—ãƒƒã‚·ãƒ¥å‰ã«ãƒªãƒ¢ãƒ¼ãƒˆã®å¤‰æ›´ã‚’å–å¾—ï¼ˆç«¶åˆè§£æ±ºï¼‰
            git pull --rebase origin main || true
            
            # å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã‚’è©¦ã¿ã‚‹
            git push || echo "âš ï¸ ãƒ­ã‚°ã®ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ï¼ˆç¶šè¡Œï¼‰"
          fi
        continue-on-error: true

      # ========================================
      # 4. æˆåŠŸæ™‚ã®Discordé€šçŸ¥
      # ========================================
      - name: Notify on success
        if: success() && env.SUPABASE_AUDIT_FAILED != 'true' && env.SYSTEM_CHECK_FAILED != 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"embeds\": [{\"title\": \"âœ… æ—¥æ¬¡ç›£æŸ»ãƒ»ã‚·ã‚¹ãƒ†ãƒ ç‚¹æ¤œ æˆåŠŸ\", \"description\": \"å…¨ã¦ã®ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™ã€‚\", \"color\": 5763719, \"fields\": [{\"name\": \"æ—¥æ™‚\", \"value\": \"${TIMESTAMP}\", \"inline\": true}, {\"name\": \"Supabaseç›£æŸ»\", \"value\": \"âœ… æ­£å¸¸\", \"inline\": true}, {\"name\": \"ã‚·ã‚¹ãƒ†ãƒ ç‚¹æ¤œ\", \"value\": \"âœ… æ­£å¸¸\", \"inline\": true}], \"footer\": {\"text\": \"Cursorvers System\"}, \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}]}"
          fi

      # ========================================
      # 5. å¤±æ•—æ™‚ã®Discordé€šçŸ¥
      # ========================================
      - name: Notify on failure
        if: failure() || env.SUPABASE_AUDIT_FAILED == 'true' || env.SYSTEM_CHECK_FAILED == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')
            
            SUPABASE_STATUS="âœ… æ­£å¸¸"
            if [ "$SUPABASE_AUDIT_FAILED" = "true" ]; then
              SUPABASE_STATUS="âŒ ã‚¨ãƒ©ãƒ¼"
            elif [ "$SUPABASE_AUDIT_STATUS" = "warning" ]; then
              SUPABASE_STATUS="âš ï¸ è­¦å‘Š"
            fi
            
            SYSTEM_STATUS="âœ… æ­£å¸¸"
            if [ "$SYSTEM_CHECK_FAILED" = "true" ]; then
              SYSTEM_STATUS="âŒ ã‚¨ãƒ©ãƒ¼"
            fi
            
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"embeds\": [{\"title\": \"ğŸš¨ æ—¥æ¬¡ç›£æŸ»ãƒ»ã‚·ã‚¹ãƒ†ãƒ ç‚¹æ¤œ å•é¡Œæ¤œå‡º\", \"description\": \"ã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\", \"color\": 15158332, \"fields\": [{\"name\": \"æ—¥æ™‚\", \"value\": \"${TIMESTAMP}\", \"inline\": true}, {\"name\": \"Supabaseç›£æŸ»\", \"value\": \"${SUPABASE_STATUS}\", \"inline\": true}, {\"name\": \"ã‚·ã‚¹ãƒ†ãƒ ç‚¹æ¤œ\", \"value\": \"${SYSTEM_STATUS}\", \"inline\": true}], \"footer\": {\"text\": \"Cursorvers System\"}, \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}]}"
          fi
          
          # Fail the workflow if there are critical errors
          if [ "$SUPABASE_AUDIT_FAILED" = "true" ] || [ "$SYSTEM_CHECK_FAILED" = "true" ]; then
            exit 1
          fi
