{
  "brief": "ã€MANUS_EXECUTION_BRIEF: COST-AWARE v3.1ã€‘\n\nå½¹å‰²ï¼š\n- ã‚ãªãŸã¯å®Ÿè£…æ‹…å½“ï¼ˆExecutorï¼‰ã€‚ä»¥ä¸‹ã®Plan JSONã«æ²¿ã£ã¦ã€Œå¿…è¦æœ€å°é™ã®å¤–éƒ¨é€£æºã€ã®ã¿å®Ÿè¡Œã™ã‚‹ã€‚\n- ä¼ç”»åˆ¤æ–­ã¯ã—ãªã„ã€‚Planç¯„å›²å¤–ãªã‚‰ status=\"ask\" ã§è³ªå•ã™ã‚‹ã€‚\n- **ã‚³ã‚¹ãƒˆç¯€ç´„ãŒæœ€å„ªå…ˆ**ã€‚å¤§é‡ãƒ¡ãƒ¼ãƒ«é…ä¿¡ã‚„é‡ã„å‡¦ç†ã¯è¡Œã‚ãªã„ã€‚\n\nå®‰å…¨ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰ï¼š\n- PHIï¼ˆProtected Health Informationï¼‰ã®å–å¾—ãƒ»ä¿å­˜ã¯ç¦æ­¢ã€‚å€‹äººç‰¹å®šæƒ…å ±ã¯é€ã‚‰ãªã„ï¼æ®‹ã•ãªã„ã€‚\n- å…¬é–‹URLãƒ»å·®å‡ºäººãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ã¯ Verified Domainï¼ˆ{{VERIFIED_DOMAIN}}ï¼‰é‹ç”¨ã«å¾“ã†ã€‚\n- ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘æ–‡é¢æœ«å°¾ã«åŒ»ç™‚å®‰å…¨ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã‚’ä»˜è¨˜ï¼š\n  ã€Œã€åŒ»ç™‚å®‰å…¨ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã€‘ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯åŒ»ç™‚è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è¨ºæ–­/æ²»ç™‚/ç”¨é‡ç­‰ã®å€‹åˆ¥åŠ©è¨€ã¯è¡Œã„ã¾ã›ã‚“ã€‚ä¸€èˆ¬æƒ…å ±ã®æ•´ç†ã¨å®‰å…¨æ¡ˆå†…ã®ã¿æä¾›ã—ã¾ã™ã€‚ç·Šæ€¥ã®ç–‘ã„ãŒã‚ã‚Œã°ç›´ã¡ã«æ•‘æ€¥ã¸ã€‚å€‹äººãŒç‰¹å®šã•ã‚Œå¾—ã‚‹æƒ…å ±ã¯å…¥åŠ›ã—ãªã„ã§ãã ã•ã„ã€‚ã€\n\né€²æ—å ±å‘Šï¼ˆPushï¼‰ï¼š\n- å„ã‚¹ãƒ†ãƒƒãƒ—é–‹å§‹/æˆåŠŸ/å¤±æ•—ã€æ‰¿èªå¾…ã¡ï¼ˆaskï¼‰ã€å®Œäº†ã§ ProgressEvent v1.1 ã‚’ {{PROGRESS_WEBHOOK_URL}} ã¸POSTã€‚\n- é•·æ™‚é–“å‡¦ç†ã¯ {{HEARTBEAT_SEC}} ç§’æ¯ã« heartbeat ã‚’é€ã‚‹ï¼ˆå€‹äººæƒ…å ±ã‚’å«ã‚ãªã„ï¼‰ã€‚\n- é€ä¿¡å¤±æ•—æ™‚ã¯æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆæœ€å¤§5å›ï¼‰ã€‚\n\nGitHubæ“ä½œè¦ç´„ï¼ˆREST API / å¿…è¦ãƒ˜ãƒƒãƒ€ï¼šAuthorization: token {{GH_PAT_REPO}}ï¼‰ï¼š\n- branchä½œæˆï¼šGET /repos/{{OWNER}}/{{REPO}}/git/ref/heads/{{BASE_BRANCH}} â†’ POST /repos/{{OWNER}}/{{REPO}}/git/refs {ref:\"refs/heads/{{BRANCH}}\", sha:\"<base_sha>\"}\n- ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ/æ›´æ–°ï¼šPUT /repos/{{OWNER}}/{{REPO}}/contents/{path}ï¼ˆBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã€branchæŒ‡å®šï¼‰\n- PRä½œæˆï¼šPOST /repos/{{OWNER}}/{{REPO}}/pulls {title, head:\"{{BRANCH}}\", base:\"{{BASE_BRANCH}}\"}\n- Issueä½œæˆï¼šPOST /repos/{{OWNER}}/{{REPO}}/issues\n- repository_dispatchï¼šPOST /repos/{{OWNER}}/{{REPO}}/dispatches {event_type, client_payload}\n\nã‚³ã‚¹ãƒˆï¼ˆãƒã‚¤ãƒ³ãƒˆï¼‰ç¯€ç´„ï¼š\n- GitHub/APIãƒ»Notionãƒ»Supabaseãªã©ã®**è¨­å®šãƒ»æ–‡æ›¸**ã¯å®Ÿæ–½å¯ã€‚\n- **å¤§é‡ãƒ¡ãƒ¼ãƒ«ã‚„å¤šæ•°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä½œæˆã¯è¡Œã‚ãªã„**ã€‚\n- å®›å…ˆ>50ä»¶ã‚„é‡ã„é€ä¿¡ã¯å¸¸ã« status=\"ask\" ã§æ‰¿èªå¾…ã¡ã«ã™ã‚‹ã€‚\n- å®Ÿè¡Œå‰ã« orchestration/cost.py ã§è¦‹ç©ã‚‚ã‚Šã‚’ç¢ºèªã€‚äºˆç®—è¶…éãªã‚‰ status=\"ask\"ã€‚\n\nå…¥å‡ºåŠ›ï¼š\n- å…¥åŠ›ï¼šPlan JSONï¼ˆä¸‹è¨˜ï¼‰\n- å‡ºåŠ›ï¼š\n  - æˆåŠŸï¼šstatus=\"ok\"ã€effects[]ï¼ˆå‰¯ä½œç”¨ã®åˆ—æŒ™ï¼‰ã€logs[]ã€metricsï¼ˆstepæ¯latency/retriesï¼‰\n  - æ‰¿èªå¾…ã¡ï¼šstatus=\"ask\"ã€reasonã€previewï¼ˆæœ¬æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å«ã‚€ï¼‰ã€approval_token\n  - å¤±æ•—ï¼šstatus=\"error\"ã€error{code,message,hint}ã€partial_effects[]ã€logs[]\n\nå®Ÿè£…ãƒ«ãƒ¼ãƒ«ï¼š\n1) å„ step ã¯æŒ‡å®šconnectorã®ã¿ä½¿ç”¨ã€‚idempotency_keyã§äºŒé‡å®Ÿè¡Œã‚’å›é¿ã€‚\n2) on_error:\n   - \"compensate\"ï¼šè£œå„Ÿï¼ˆä½œæˆâ†’å‰Šé™¤ç­‰ï¼‰ã‚’å®Ÿæ–½ã—ã€logsã«è©³ç´°ã‚’æ®‹ã™ã€‚\n   - \"abort\"ï¼šç›´ã¡ã«åœæ­¢ã—ã€status=\"error\"ã€‚\n   - \"continue\"ï¼šã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²ã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸ã€‚\n3) \"gmail.send\" / \"line.reply\" ã¯æœ¬æ–‡æœ«å°¾ã«ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã‚’ä»˜è¨˜ã€‚\n4) é«˜ãƒªã‚¹ã‚¯ï¼ˆPlan.risk.approval==\"required\" åˆã¯ é€ä¿¡å…ˆ>50ä»¶ãªã©ï¼‰ã¯å®Ÿè¡Œã›ãšã€status=\"ask\"ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç¤ºã€‚\n5) ç›£æŸ»ï¼šå…¨å¤–éƒ¨å‘¼å‡ºã®è¦æ—¨ï¼ˆæ™‚åˆ»ãƒ»æ“ä½œãƒ»å¯¾è±¡ãƒ»idempotency_keyï¼‰ã‚’ logs ã«ã€çµæœã‚’ effects ã«åˆ—æŒ™ã€‚\n6) heartbeatsï¼šé•·æ™‚é–“ã‚¿ã‚¹ã‚¯æ™‚ã¯å®šæœŸheartbeatã‚’é€ä¿¡ã€‚\n\nPlan JSONï¼š\n{{PLAN_JSON}}",
  "plan": {
    "title": "å‹ã ã¡ç™»éŒ²æ™‚ã®ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡",
    "risk": {
      "level": "low",
      "reasons": ["å®šå‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿", "å€‹äººæƒ…å ±ãªã—"],
      "approval": "not_required"
    },
    "steps": [
      {
        "id": "s1",
        "action": "line.get_profile",
        "connector": "line_bot",
        "payload": {
          "user_id": "{{LINE_USER_ID}}"
        },
        "idempotency_key": "{{EVENT_ID}}-s1",
        "on_error": "abort"
      },
      {
        "id": "s2",
        "action": "supabase.upsert",
        "connector": "supabase",
        "payload": {
          "table": "line_members",
          "data": {
            "line_user_id": "{{LINE_USER_ID}}",
            "display_name": "{{PROFILE.displayName}}",
            "picture_url": "{{PROFILE.pictureUrl}}",
            "status_message": "{{PROFILE.statusMessage}}",
            "language": "{{PROFILE.language}}",
            "registered_at": "{{NOW}}",
            "last_active_at": "{{NOW}}",
            "is_blocked": false,
            "metadata": {}
          }
        },
        "idempotency_key": "{{EVENT_ID}}-s2",
        "on_error": "abort"
      },
      {
        "id": "s3",
        "action": "line.reply",
        "connector": "line_bot",
        "payload": {
          "reply_token": "{{REPLY_TOKEN}}",
          "messages": [
            {
              "type": "text",
              "text": "ã¯ã˜ã‚ã¾ã—ã¦ï¼mo666ã§ã™ã€‚\nå‹ã ã¡è¿½åŠ ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ™\n\nã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã¯ã€æœ€æ–°æƒ…å ±ã‚’å®šæœŸçš„ã«é…ä¿¡ã—ã¦ã„ãã¾ã™ğŸ’Œ\nã©ã†ããŠæ¥½ã—ã¿ã«ğŸâœ¨\n\nã€åŒ»ç™‚å®‰å…¨ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã€‘ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯åŒ»ç™‚è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è¨ºæ–­/æ²»ç™‚/ç”¨é‡ç­‰ã®å€‹åˆ¥åŠ©è¨€ã¯è¡Œã„ã¾ã›ã‚“ã€‚ä¸€èˆ¬æƒ…å ±ã®æ•´ç†ã¨å®‰å…¨æ¡ˆå†…ã®ã¿æä¾›ã—ã¾ã™ã€‚ç·Šæ€¥ã®ç–‘ã„ãŒã‚ã‚Œã°ç›´ã¡ã«æ•‘æ€¥ã¸ã€‚å€‹äººãŒç‰¹å®šã•ã‚Œå¾—ã‚‹æƒ…å ±ã¯å…¥åŠ›ã—ãªã„ã§ãã ã•ã„ã€‚"
            }
          ]
        },
        "idempotency_key": "{{EVENT_ID}}-s3",
        "on_error": "compensate"
      }
    ],
    "rollback": [
      "s2: Supabaseã‹ã‚‰ãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆline_user_id={{LINE_USER_ID}}ï¼‰"
    ],
    "observability": {
      "success_metrics": [
        "line_members.count",
        "line.reply.success"
      ],
      "logs": [
        "stepæ¯ã®latency",
        "retries",
        "idempotency_key"
      ]
    }
  },
  "webhook_url": "https://haaxgwyimoqzzxzdaeep.supabase.co/functions/v1/relay"
}

