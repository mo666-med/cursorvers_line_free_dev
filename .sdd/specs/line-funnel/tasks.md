# Tasks – Cursorvers LINE Funnel（現行イテレーション）

参照設計: `.sdd/specs/line-funnel/design.md`。各タスクは設計ドキュメントの該当セクションに紐づけ、`/sdd-implement` での実装順序決定に利用する。

| # | タイトル / 目的 | オーナー | 優先度 | 設計参照 | 主要ファイル / モジュール | 完了条件 & テスト | 依存関係 | 並行実行 |
|---|----------------|----------|---------|-----------|----------------------------|--------------------|------------|------------|
| T1 | Front Door リレーの強化（署名検証・ハッシュ化・重複排除・dispatch） | Edge Backend | P0 | [Architecture Overview](design.md#architecture-overview)<br>[Detailed Flow Scenarios](design.md#detailed-flow-scenarios)<br>[repository_dispatch Payloads](design.md#repository_dispatch-payloads) | `functions/relay/index.ts`<br>`functions/relay/kv.ts`<br>`tests/relay/**/*.test.ts` | Deno テストで LINE/Manus 両方の署名検証・KV/メモリフォールバック・マスキング切替を網羅、サンドボックス向け `repository_dispatch` ドライラン成功、構造化ログ確認済み | なし | 可 |
| T2 | Supabase スキーマとマイグレーション（line_members/progress/budget）確定 | Data/Infra | P0 | [Data Models & API Contracts](design.md#data-models--api-contracts) | `database/migrations/**`<br>`scripts/supabase/check-schema.js`<br>`tests/node/supabase-schema.test.mjs` | ステージングで forward/rollback が成功、スキーマ検証 + 単体テスト合格、ハッシュ一意制約をフィクスチャで確認 | なし | 可 |
| T3 | Google Sheets 台帳自動化と突合作業フック実装 | Ops Automation | P0 | [Google Sheets Ledger](design.md#google-sheets-ledger-interim-crm)<br>[Deployment & Migration](design.md#deployment--migration-considerations) | `scripts/sheets/upsert-line-member.js`<br>`scripts/reconcile-ledgers.ts`<br>`tests/node/sheets-ledger.test.mjs` | サービスアカウントで認証テスト済み、台帳アップサート & 突合がモックで通る、Sheets 無効フラグ時のパスもユニットテスト | T2 | 一部可（モック試験は並行可） |
| T4 | フィーチャーフラグ/設定ユーティリティと秘密情報検証の強化 | Platform | P0 | [Patterns & Libraries](design.md#patterns--libraries)<br>[Testing Strategy](design.md#testing-strategy)<br>[Deployment & Migration](design.md#deployment--migration-considerations) | `scripts/lib/feature-flags.js`<br>`tests/node/feature-flags.test.mjs`<br>`scripts/verify-secrets.sh` | フラグマトリクスを文書化、全フラグ組み合わせをテスト、`verify-secrets` ワークフローが不足キーで失敗することを確認 | なし | 可 |
| T5 | 本番/ディグレード用プラン資産と検証ツールの同期 | DevOps/Plan | P0 | [Architecture Overview](design.md#architecture-overview)<br>[Data Models & API Contracts](design.md#data-models--api-contracts)<br>[Deployment & Migration](design.md#deployment--migration-considerations) | `orchestration/plan/**`<br>`scripts/plan/validate-plan.js`<br>`docs/alerts/line_degraded_outreach.ics` | プラン検証スクリプトで本番/ディグレードが共に合格、`degraded.flag` スイッチをワークフロードライランで確認、関連ドキュメント更新 | T4 | 一部可 |
| T6 | LINE inbound ワークフロー（デュアル書き込み・通知・ガードレール）構築 | DevOps | P0 | [Detailed Flow Scenarios](design.md#detailed-flow-scenarios)<br>[Logs and Artifacts](design.md#logs-and-artifacts)<br>[Testing Strategy](design.md#testing-strategy) | `.github/workflows/line-event.yml`<br>`scripts/supabase/upsert-line-event.js`<br>`scripts/sheets/upsert-line-member.js`<br>`logs/progress/` | `act` などで通常/ディグレード両経路テスト、Supabase & Sheets 書き込み検証、ガードレール文言付与確認、JSON ログ commit、失敗時の通知確認 | T1, T2, T3, T4, T5 | 不可 |
| T7 | Manus progress ワークフロー（再試行・デグレード制御）実装 | DevOps | P0 | [Detailed Flow Scenarios](design.md#detailed-flow-scenarios)<br>[repository_dispatch Payloads](design.md#repository_dispatch-payloads)<br>[Testing Strategy](design.md#testing-strategy) | `.github/workflows/manus-progress.yml`<br>`scripts/supabase/upsert-progress-event.js`<br>`scripts/manus/retry-task.ts` | Manus 成功/失敗シナリオをモックで統合テスト、同時実行と idem 制御を検証、Supabase 登録確認、Step Summary で PlanDelta 整合を報告 | T1, T2, T4, T5 | 一部可（共有ライブラリ後） |
| T8 | ワークフロー外部依存（`wget yq` 等）のサプライチェーン対策 | DevOps/Platform | P0 | [Risks & Mitigations](design.md#risks--mitigations) | `.github/workflows/economic-circuit-breaker.yml`<br>`docs/automation/WORKFLOWS.md`<br>`scripts/tools/install-yq.sh` (新規) | `yq` 取得手順にバージョン固定とチェックサム検証を追加、または代替 GitHub Action/ベンダリングを導入。検証ログを残し、Runbook に手順反映。 | T4 | 可 |
| T9 | コスト統治（コスト推定 + エコノミックブレーカー）実装 | Finance/DevOps | P0 | [Detailed Flow Scenarios](design.md#detailed-flow-scenarios)<br>[Risks & Mitigations](design.md#risks--mitigations) | `.github/workflows/economic-circuit-breaker.yml`<br>`orchestration/cost.py`<br>`BUDGET.yml` | 閾値計算の単体テスト、ワークフロードライランで予算超過通知、Supabase にスナップショット記録、`degraded.flag` 生成確認 | T2, T4, T5, T8 | 一部可 |
| T10 | テレメトリー & KPI レポート導線の実装 | Data Ops | P1 | [Logs and Artifacts](design.md#logs-and-artifacts)<br>[Testing Strategy](design.md#testing-strategy) | `.github/workflows/weekly-kpi-report.yml`<br>`scripts/kpi/generate-kpi-report.js`<br>`logs/progress/` | Supabase RPC をフィクスチャで呼び出し、Step Summary に KPI 表示、通知チャネル確認、Supabase ダウン時フォールバックもテスト | T2, T6, T7 | 不可 |
| T11 | ログローテーションと保持ポリシーの実装 | Platform Ops | P1 | [Logs and Artifacts](design.md#logs-and-artifacts)<br>[Risks & Mitigations](design.md#risks--mitigations) | `.github/workflows/rotate-logs.yml`<br>`scripts/rotate-logs.sh`<br>`logs/progress/archive/` | 90 日超データでローテーションシミュレーション、リポサイズ閾値通知、保持ロジックのユニットテスト | T6, T7 | 一部可 |
| T12 | Secrets 検証とデプロイ準備ワークフロー仕上げ | Platform | P0 | [Deployment & Migration](design.md#deployment--migration-considerations)<br>[Risks & Mitigations](design.md#risks--mitigations) | `.github/workflows/verify-secrets.yml`<br>`docs/ENV_VAR_SETUP.md`<br>`scripts/setup-manus-env.sh` | ワークフローで必要秘密/vars をチェック、ドキュメント更新、新規環境でオンボードスクリプト検証 | T4 | 可 |
| T13 | ステージング E2E 検証と運用 Runbook 更新 | Program Lead | P1 | [Testing Strategy](design.md#testing-strategy)<br>[Deployment & Migration](design.md#deployment--migration-considerations)<br>[Risks & Mitigations](design.md#risks--mitigations) | `RUNBOOK.md`<br>`docs/ops/**`<br>`tests/e2e/**` | ステージング Front Door をデプロイし LINE/Manus ペイロードでループ検証、ディグレード切替ドキュメント化、Runbook にロールバック/ICS 手順反映 | T1–T12 | 不可 |

**想定ブロッカー**
- Supabase サービスロールキーの配布準備が整うまで T2/T6/T7/T9/T10 が進捗待ちになる可能性。
- Google サービスアカウント承認と Sheets 共有設定が完了するまで T3 の本番検証ができない。
- Manus サンドボックス／コスト推定 API が利用可能でない場合、T7/T9 の動作検証が遅延。
- Front Door から `repository_dispatch` を叩く PAT もしくは GitHub App 権限が未付与の場合、T1 のドライランが実行不可。
- note→LINE KPI・メッセージ頻度の最終決定が遅延すると T6/T10 のガードレール設定が暫定値に留まるため、ステークホルダー合意が必要。
