# Line Actions Orchestration – Tasks

Primary reference: [.sdd/specs/line-actions-orchestration/design.md](design.md). Every design section (Architecture, Detailed Approach, Testing, Risks, Deployment, Open Questions) has at least one mapped task below.

| Priority | Task (Design Ref) | Objective | Owner | Files / Modules | Definition of Done | Validation & Tests | Dependencies / Parallel Notes | Status |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| P0 | Spec Loader & Rule Engine ([§1.2](design.md#12-spec-driven-orchestration), [§2.1](design.md#21-spec-loader--router)) | Implement spec validation + normalized runtime loader powering rule execution | Backend | `codex.spec.yaml`, `schemas/codex-spec.schema.json`, `scripts/orchestration/{load-spec,execute-rules}.mjs` | Spec passes schema validation, loader exports canonical structure consumed by Actions, sample events return action plans | `npm run lint:spec`, `node --test scripts/orchestration/execute-rules.test.mjs` | Foundation task; must finish before router, constraints, or actions | Ready |
| P0 | LINE Event Intake & Router ([§1.1](design.md#11-system-boundaries--data-flow), [§2.2](design.md#22-event-sources)) | Route LINE follow/text payloads through Deno relay and into spec engine with dedupe + signature checks | DevOps | `functions/relay/index.ts`, `.github/workflows/line-event.yml`, `scripts/orchestration/execute-rules.mjs` | Repository dispatch emits canonical event IDs, relay enforces signature + replay defense, router invokes spec | `act -W .github/workflows/line-event.yml`, `npm run test:actions -- --case line-follow` | Starts immediately after spec loader; unblocks tag state/constraints | Ready |
| P0 | User Tag State Service ([§2.3](design.md#23-tag-management)) | Provide unified tag/state read/write API over Supabase + Sheets for rule actions | Backend/Data | `scripts/orchestration/user-state.mjs`, Supabase schema, Sheets helpers | Rule actions fetch/update tags via shared module; Supabase + Sheets stay in sync with audit logs | `node --test scripts/orchestration/user-state.test.mjs`, `npm run test:actions -- --case tag-updates` | Parallel with router once loader contracts stabilized | Ready |
| P0 | Guardrail Enforcement: PHI + Verified Links ([§2.4](design.md#24-message-delivery--constraints)) | Add configurable PHI filter + verified-domain check before outbound replies | Backend/Security | `scripts/orchestration/{phi-filter,verified-links}.mjs`, `codex.spec.yaml` | Violations block messaging, emit Supabase entries, and send warning template | `node --test scripts/orchestration/phi-filter.test.mjs`, `node --test scripts/orchestration/verified-links.test.mjs` | Requires spec loader + router; can run with tag service in parallel | Ready |
| P0 | Broadcast & Promo Limit Controls ([§2.4](design.md#24-message-delivery--constraints)) | Enforce monthly broadcast cap + promo cooldown via Supabase metadata | Backend/Data | `scripts/orchestration/broadcast-limits.mjs`, `scripts/orchestration/user-state.mjs`, `.github/workflows/line-event.yml` | LINE replies consult usage counters before send; metadata updates atomically | `node --test tests/actions/broadcast-limits.test.mjs`, `npm run test:actions -- --case promo-limit` | Depends on tag service; can proceed before Discord work | Ready |
| P0 | Validation & CI Harness ([§3](design.md#3-testing-strategy)) | Stand up schema lint, rule tests (V1–V12), and act-based smoke workflows | QA/DevOps | `tests/actions/orchestration/*.mjs`, `ci-smoke-act.yml`, `node-tests.yml`, `package.json` scripts | CI blocks regressions via `npm test`, `lint:spec`, and `act` smoke runs | `npm run test:actions`, `npm run lint:spec`, `act -W ci-smoke-act.yml` | Begins once loader skeleton exists; runs continuously with other tasks | Ready |
| P0 | Risk Alignment: Discord API & note Payload Contracts ([§4](design.md#4-risks--mitigations), [§6](design.md#6-open-questions)) | Secure written contracts for Discord endpoints + note webhook schema + retry policy | PM/Backend | `docs/automation/discord-api-contract.md` (new), `schemas/note-webhook.schema.json`, decision log | API auth, rate limits, payload fields documented; design updated; blockers cleared | Stakeholder sign-off artefact, `npm run lint:spec` on schemas | Pre-req for Discord + note tasks; engage stakeholders early | In Progress |
| P1 | Discord Action Client & Workflows ([§2.5](design.md#25-discord-integration), [§4](design.md#4-risks--mitigations)) | Build Discord client, action handlers (`create_private_log`, `push_material`), degraded-mode alerts | Backend | `scripts/discord/client.mjs`, `scripts/orchestration/actions/discord.mjs`, `.github/workflows/line-event.yml`, Secrets | `cmd_start_course` etc. invoke Discord API with retries + Ops alerts; degraded flag toggles spec | `node --test scripts/discord/client.test.mjs`, `npm run test:actions -- --case cmd_start_course` | Blocked until Risk Alignment delivers API contract + secrets | Blocked |
| P1 | Logging & Artifact Pipeline Refresh ([§2.6](design.md#26-logging--artifact)) | Align Supabase logging + GitHub artefact retention with new rule outputs | DevOps | `scripts/orchestration/log-writer.mjs`, `scripts/orchestration/reply-line-templates.mjs`, `.github/workflows/line-event.yml` | Every event writes JSON log + uploads artefact; Ops can fetch replay bundle | `npm run test:actions -- --case logging`, `act -W .github/workflows/line-event.yml` | Parallel once router + loader exist | Ready |
| P1 | note Webhook Handler & Dispatch ([§1.1](design.md#11-system-boundaries--data-flow), [§2.2](design.md#22-event-sources), [§5](design.md#5-deployment--migration-plan)) | Receive note `viewed_note` / `payment_completed`, dedupe, persist, and forward event | DevOps | `.github/workflows/note-event.yml`, `supabase/functions/note-webhook.ts` (new), `schemas/note-webhook.schema.json` | Handler verifies signature, stores payload, triggers `line-event` with normalized IDs | `act -W .github/workflows/note-event.yml`, `npm run test:actions -- --case note-payment` | Blocked by Risk Alignment for schema; runs after loader/CI wiring | Blocked |
| P1 | Secrets & Runtime Prep ([§5](design.md#5-deployment--migration-plan)) | Provision GitHub secrets/vars + runtime registry entries for spec-driven flow | DevOps | `.github/workflows/*.yml`, `config/workflows/runtime-parameters.json`, `docs/ENV_VAR_SETUP.md`, GitHub Secrets | `runtime-parameters.json` + docs list every secret; `npm run runtime:verify` passes | `npm run runtime:verify`, secrets audit checklist | Can start after loader; prerequisite for Discord, note, promo tasks | Ready |
| P2 | Tag Migration & Data Backfill ([§5](design.md#5-deployment--migration-plan)) | Migrate existing leads/tags into new schema with rollback + audit | Backend/Ops | `scripts/orchestration/migrate-tags.mjs`, Supabase migration scripts, `docs/runbooks/line-actions.md` | Dry-run + prod run recorded; counts match expectations; rollback plan stored | `node scripts/orchestration/migrate-tags.mjs --dry-run`, staging verification checklist | Requires tag service + secrets; precedes Ops enablement | Ready |
| P2 | Ops Enablement & Runbook Update ([§5](design.md#5-deployment--migration-plan)) | Train Ops on new commands, Discord flow, note pipeline; update runbooks | Ops | `docs/runbooks/line-actions.md`, `docs/operations/*`, training deck/logs | Updated runbook merged; Ops dry-run recorded; acknowledgements archived | Runbook review checklist, Ops sign-off notes | Starts after migration + Discord workflows validated | Ready |

## Notes & Blockers
- Design sections §1–§6 are all represented: architecture/routing (Tasks 1–5), detailed components (§2.x) (Tasks 1–9), testing (§3) (Task 6), risks (§4/§6) (Tasks 7–8, 10), deployment/migration (§5) (Tasks 10–13).
- Discord client and note webhook work remain blocked pending external API contracts; Risk Alignment task tracks that dependency.
- Broadcast/promo controls may require Supabase performance tuning—capture follow-up tasks if query cost exceeds targets noted in §4.
- Verified-domain list stewardship rolls into Secrets & Runtime Prep; schedule periodic review once initial allowlist lands.
- `ci-smoke-act.yml` can run in parallel with feature work but should become a required check once Task 6 stabilizes; flag in CI planning discussions.
