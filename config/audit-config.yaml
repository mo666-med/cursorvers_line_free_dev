# Cursorvers System Audit Configuration
# Updated: 2026-01-03
# Description: 日次システム点検用の設定ファイル

# ===========================================
# 役割分担（IMPORTANT）
# ===========================================
#
# ┌────────────────┐        ┌────────────────┐
# │ GitHub Actions │  ────▶ │     Manus      │
# │   (監査実行)    │        │  (自動修復のみ)  │
# └────────────────┘        └────────────────┘
#
# - 監査実行: GitHub Actions (manus-audit-daily.yml)
# - 自動修復: Manus (異常検出時のみ起動)
# - Manus は監査を実行しない
# - Manus は n8n/Supabase接続テストを行わない
#

# ===========================================
# 監査対象サービス
# ===========================================

services:
  # LINE Bot (Supabase Edge Function)
  line_bot:
    name: "LINE Bot"
    endpoint: "https://haaxgwyimoqzzxzdaeep.supabase.co/functions/v1/line-bot"
    method: "GET"
    # HTTP 401は認証ヘッダーなしの正常応答として許容
    expected_status: [200, 401]
    enabled: true
    notes: "401は認証ヘッダーなしの正常応答"

  # n8n Workflow
  n8n:
    name: "n8n Workflow"
    base_url: "https://n8n.srv995974.hstgr.cloud"
    api_endpoint: "/api/v1/workflows"
    # GitHub Secrets: N8N_API_KEY (末尾XHBU, Never expires)
    api_key_source: "github_secrets"
    api_key_name: "N8N_API_KEY"
    enabled: true
    notes: "2025-12-16にAPI Key更新済み"

  # Supabase
  supabase:
    name: "Supabase"
    project_url: "https://haaxgwyimoqzzxzdaeep.supabase.co"
    # GitHub Secrets: SUPABASE_ACCESS_TOKEN
    access_token_source: "github_secrets"
    access_token_name: "SUPABASE_ACCESS_TOKEN"
    # MCP経由のログ取得は環境変数未設定のためスキップ
    mcp_log_check: false
    enabled: true
    notes: "Edge Function稼働確認のみ、MCPログ取得はスキップ"

  # Discord Webhook
  discord:
    name: "Discord Webhook"
    # GitHub Secrets: DISCORD_ADMIN_WEBHOOK_URL
    webhook_source: "github_secrets"
    webhook_name: "DISCORD_ADMIN_WEBHOOK_URL"
    enabled: true
    notes: "2025-12-16に接続テスト成功"

  # GitHub Repositories
  github:
    name: "GitHub"
    repositories:
      - owner: "mo666-med"
        repo: "cursorvers_line_free_dev"
        enabled: true
    # 除外リポジトリ（監査対象外）
    excluded_repositories:
      - repo: "cursorvers_line_paid_dev"
        reason: "削除済みリポジトリ"
    notes: "paid_devは削除済みのため監査対象外"

# ===========================================
# 監査スケジュール
# ===========================================

schedule:
  # 毎朝6時（JST）に実行
  cron: "0 21 * * *"  # UTC 21:00 = JST 06:00
  notification_mode: "always"  # 正常時も通知する
  timezone: "Asia/Tokyo"

# ===========================================
# 報告設定
# ===========================================

reporting:
  # Discord報告
  discord:
    enabled: true
    webhook_name: "DISCORD_ADMIN_WEBHOOK_URL"
    channel: "system-alerts"
  
  # GitHub ログ保存
  github:
    enabled: true
    repository: "mo666-med/cursorvers_line_free_dev"
    log_path: "docs/logs/"
    auto_push: true

# ===========================================
# 正常応答の定義（誤検出防止）
# ===========================================

expected_responses:
  # LINE Bot Edge Function
  line_bot_no_auth:
    status: 401
    message: "Missing signature"
    is_normal: true
    description: "署名または内部シークレットなしのアクセスは401が正常"

  # Supabase MCP
  supabase_mcp_no_token:
    error: "Unauthorized"
    is_normal: true
    description: "Manus環境変数にSUPABASE_ACCESS_TOKEN未設定のため、MCPログ取得はスキップ"

# ===========================================
# 除外項目（監査対象外）
# ===========================================

exclusions:
  # 削除済みリポジトリ
  - type: "github_repository"
    name: "mo666-med/cursorvers_line_paid_dev"
    reason: "削除済み"
    date: "2025-12-16"

  # Manus環境変数未設定項目
  - type: "mcp_check"
    name: "supabase_logs"
    reason: "SUPABASE_ACCESS_TOKEN未設定"
    date: "2025-12-16"

# ===========================================
# 更新履歴
# ===========================================

changelog:
  - date: "2026-01-03"
    changes:
      - "役割分担を明確化: GitHub Actions=監査, Manus=自動修復のみ"
      - "MANUS_ROLE_DEFINITION.md を作成"
      - "Manus は n8n/Supabase接続テストを行わないルールを明記"

  - date: "2025-12-16"
    changes:
      - "N8N_API_KEY更新（末尾XHBU, Never expires）"
      - "N8N_INSTANCE_URL修正"
      - "Discord Webhook接続テスト成功"
      - "paid_devリポジトリを監査対象から除外"
      - "LINE Bot 401応答を正常として定義"
      - "Supabase MCPログ取得をスキップに設定"
