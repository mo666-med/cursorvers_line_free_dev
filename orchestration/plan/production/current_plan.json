{
  "id": "line_welcome_v1",
  "version": "2025-11-03",
  "title": "LINEå‹ã ã¡ç™»éŒ²æ™‚ã®ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰",
  "metadata": {
    "channel": "line",
    "description": "ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã™ã‚‹åˆå›å¿œç­”ã¨å°å¸³æ›´æ–°ã‚’è‡ªå‹•åŒ–ã™ã‚‹"
  },
  "risk": {
    "level": "low",
    "reasons": [
      "é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å›ºå®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã¿",
      "ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ãƒãƒƒã‚·ãƒ¥IDã®ã¿ã‚’ä¿å­˜ã—PIIã‚’æ‰±ã‚ãªã„"
    ],
    "approval": "not_required"
  },
  "steps": [
    {
      "id": "profile_lookup",
      "action": "line.get_profile",
      "connector": "line_bot",
      "payload": {
        "user_id": "{{HASHED_USER_ID}}",
        "original_user_token_hint": "{{ORIGINAL_USER_TOKEN_HINT}}"
      },
      "idempotency_key": "{{EVENT_ID}}:profile",
      "on_error": "abort"
    },
    {
      "id": "record_member",
      "action": "supabase.upsert",
      "connector": "supabase",
      "payload": {
        "table": "line_members",
        "conflict_target": ["user_hash"],
        "data": {
          "user_hash": "{{HASHED_USER_ID}}",
          "first_opt_in_at": "{{EVENT_RECEIVED_AT}}",
          "last_opt_in_at": "{{EVENT_RECEIVED_AT}}",
          "cta_tags": [],
          "status": "active",
          "guardrail_sent_at": "{{EVENT_RECEIVED_AT}}",
          "consent_guardrail": true,
          "metadata": {
            "display_name": "{{PROFILE.displayName}}",
            "picture_url": "{{PROFILE.pictureUrl}}",
            "status_message": "{{PROFILE.statusMessage}}",
            "language": "{{PROFILE.language}}",
            "latest_stage": "welcome_message_prepared",
            "last_event_type": "{{EVENT_TYPE}}",
            "reply_token": "{{REPLY_TOKEN}}"
          }
        }
      },
      "idempotency_key": "{{EVENT_ID}}:member",
      "on_error": "abort"
    },
    {
      "id": "welcome_delivery",
      "action": "line.reply",
      "connector": "line_bot",
      "payload": {
        "reply_token": "{{REPLY_TOKEN}}",
        "messages": [
          {
            "type": "text",
            "text": "ã¯ã˜ã‚ã¾ã—ã¦ï¼mo666ã§ã™ã€‚\nå‹ã ã¡è¿½åŠ ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ™\n\nã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã¯ã€æœ€æ–°æƒ…å ±ã‚’å®šæœŸçš„ã«é…ä¿¡ã—ã¦ã„ãã¾ã™ğŸ’Œ\nã©ã†ããŠæ¥½ã—ã¿ã«ğŸâœ¨\n\nã€åŒ»ç™‚å®‰å…¨ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã€‘ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯åŒ»ç™‚è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è¨ºæ–­/æ²»ç™‚/ç”¨é‡ç­‰ã®å€‹åˆ¥åŠ©è¨€ã¯è¡Œã„ã¾ã›ã‚“ã€‚ä¸€èˆ¬æƒ…å ±ã®æ•´ç†ã¨å®‰å…¨æ¡ˆå†…ã®ã¿æä¾›ã—ã¾ã™ã€‚ç·Šæ€¥ã®ç–‘ã„ãŒã‚ã‚Œã°ç›´ã¡ã«æ•‘æ€¥ã¸ã€‚å€‹äººãŒç‰¹å®šã•ã‚Œå¾—ã‚‹æƒ…å ±ã¯å…¥åŠ›ã—ãªã„ã§ãã ã•ã„ã€‚"
          }
        ]
      },
      "idempotency_key": "{{EVENT_ID}}:welcome",
      "on_error": "compensate"
    }
  ],
  "rollback": [
    "record_member: Supabase line_members ã‹ã‚‰ user_hash={{HASHED_USER_ID}} ã‚’å‰Šé™¤",
    "welcome_delivery: LINE API ã¸ã®è£œå„Ÿé€šçŸ¥ã¯ä¸è¦ã ãŒã€Slackã¸æ‰‹å‹•å ±å‘Š"
  ],
  "observability": {
    "success_metrics": [
      "supabase.line_members.upsert",
      "line.reply.success",
      "automation.duration"
    ],
    "logs": [
      "step_latency_ms",
      "retries",
      "idempotency_key",
      "manus_task_id"
    ]
  }
}
